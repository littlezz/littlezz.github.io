Title: 记一次服务器被爆破后灾后重建ss的经历


疑似被黑
------
2年前和基友合力租了一台服务器用于搭建ss服务， 当年啥也不懂， 系统选的是fedora， yum install fail2ban之后主要精力就是折腾ss， 配了supervisord， 编译了hybla的模块， 就不管了。  

2年来一直没出什么大事， 偶尔大面积100%丢包过一下就好了， 没当回事。  

直到昨天因为系统更新准备重新编译hybla， 登录上去顺便用网上抄了的命令查看了一下当前连接量， 

    netstat -an | grep 443 | grep ESTABLISHED | wc -l

大的惊人， 开始慌了。  

检查log日志， 发现大量

    2016-11-16 01:16:01 ERROR can not parse header when handling connection from ::ffff:<ip>:<port>

反查这些ip， 发现都不是我们自己的ip。  
我估计是被爆破了， 但是我端口用的是443， 所以也不太好确定是不是真的被爆破。
之后就是ban ip， 换端口， 改密码。  

接着开始考虑服务器本身有没有被攻破， 看了一下ssh的22端口， 发现有其他的ip在建立连接， 到这里我都没有特别慌张， 我想， 我还有fail2ban呢。  

检查了一下我的fail2ban， 发现处于开启失败状态。  
顺带， ssh服务没换端口， 允许root账号登录， 允许密码登录。

『卧槽， 精彩了』  

赶紧联系大腿。

先打`w`命令， 一片空白， 一般登录了的话至少有自己一个人， 现在什么也没有， 六神表示`w`估计被改了， 可能是被rootkit了， rootkit了的话基本就很难看出其他的东西了。  

往后是一些挣扎， 检查`ps -aux`， 看不出来。
检查`who -a /var/log/wtmp`, 看一下登录的信息， 看不出来。  
检查bash_history, zsh_history， 根本懒得看了。  

淦他娘啊， 我选择重装！  

灾后重建
-------
这次选了ubuntu， 而且有经验了。  

* 先装`zsh`, `apt-get install zsh`  

* 建立用户, 指定shell为zsh， `useradd youruser -m -s /bin/zsh`

* 上传公钥， 通过 `ssh-copy-id` 命令。  

* 更改ssh的配置， 改端口， 关root登录， 关密码登录。  

    ```
    PermitRootLogin no
    Port 12345
    PasswordAuthentication no
    ```
* 重启ssh服务。  

* 安装 `denyhosts`, `apt-get install denyhosts`  

* `oh-my-zsh`

    ```sh
    apt-get install git
    sh -c "$(wget https://raw.githubusercontent.com/robbyrussell/oh-my-zsh/master/tools/install.sh -O -)"
    ```


配置ss
-----
#### 更新系统， 装`pip`， `shadowsocks`

```sh
apt-get install python-pip
pip install -U pip
pip install shadowsocks
```  

#### 安装密码库， 安装`libsodium`依赖  
```sh
apt-get install python-m2crypto
apt-get install libsodium18
pip install M2Crypto
```

#### 配置`/etc/shadowsocks.json`

```json
{
    "server":"::",
    "server_port":8899,
    "local_address": "127.0.0.1",
    "local_port":1080,
    "password":"password",
    "timeout":100,
    "method":"<choose a method>",
    "fast_open": false,
    "workers": 3,
    "user":"nobody"
}
```

服务器参数设置`"::"`可以同时监听ipv4和ipv6, user设置nobody权限， 选一个加密方式， 另外最新是可以打开OTA来防止被攻击， 但是需要客户端也支持OTA。 

除此以外， 还可以用提供的 [autoban.py][1] 来ban ip,使用方法参考[Ban Brute Force Crackers][] .  
注意到同时监听ipv4和ipv6的时候， 这个代码提取ip的方式有问题，要改一下，  
第41行改成  

    ip = line.split()[-1].split(':')[-2]   

**（小心不要把自己ban了**

<br>  

#### 关于优化
参考  [shadowsocks-optimize][], 不重复了  


#### 配置开机自启动
rc.local ubuntu用不了， 需要自己写一个`shadowsocks.service`:  
在`/etc/systemd/system`下建立一个文件， 比如`shadowsocks.service`， 写入如下内容  

```ini
[Unit]
Description=run ssserver on background

[Service]
Type=forking
ExecStart=/usr/local/bin/ssserver -c /etc/shadowsocks.json -d restart
ExecStop=/usr/local/bin/ssserver -c /etc/shadowsocks.json -d stop

[Install]
WantedBy=multi-user.target
```

参考：   
[how-to-write-startup-script-for-systemd](https://unix.stackexchange.com/questions/47695/how-to-write-startup-script-for-systemd)

[systemd.service.html](https://www.freedesktop.org/software/systemd/man/systemd.service.html)

按说明， `Type`选`forking`而不是`simple`。

之后可以用`systemctl start shadowsocks` 和`systemctl stop shadowsocks` 开关ss.  

使用 `systemctl enable shadowsocks` 让ss开机启动。


总结
---
~~在被日中成长~~。  


[1]: https://github.com/shadowsocks/shadowsocks/blob/master/utils/autoban.py

[Ban Brute Force Crackers]: https://github.com/shadowsocks/shadowsocks/wiki/Ban-Brute-Force-Crackers

[shadowsocks-optimize]: https://github.com/iMeiji/shadowsocks_install/wiki/shadowsocks-optimize