<!DOCTYPE html>
<html lang="en">
<head>
  <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,400italic' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" type="text/css" href="http://littlezz.github.io/theme/css/style.min.css">
  <link rel="stylesheet" type="text/css" href="http://littlezz.github.io/theme/css/pygments.min.css">
  <link rel="stylesheet" type="text/css" href="http://littlezz.github.io/theme/css/font-awesome.min.css">
  <link href="http://littlezz.github.io/static/custom.css" rel="stylesheet">
  <link href="http://littlezz.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="littlezz's Blog Atom">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="" />
  <meta name="author" content="littlezz" />
  <meta name="description" content="littlezz's Thoughts and Writings About Python And Machine Learning and diary" />
<meta property="og:site_name" content="littlezz's Blog"/>
<meta property="og:type" content="blog"/>
<meta property="og:title" content="littlezz's Blog"/>
<meta property="og:description" content="littlezz's Thoughts and Writings About Python And Machine Learning and diary"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="http://littlezz.github.io"/>
<meta property="og:image" content="/images/logo.jpg">
  <title>littlezz's Blog</title>
</head>
<body>
  <aside>
    <div>
      <a href="http://littlezz.github.io">
        <img src="/images/logo.jpg" alt="littlezz" title="littlezz">
      </a>
      <h1><a href="http://littlezz.github.io">littlezz</a></h1>
      <p>当我被狗日时， 我在想些什么</p>
      <nav>
        <ul class="list">
        </ul>
      </nav>
      <ul class="social">
        <li><a class="sc-github" href="https://github.com/littlezz/" target="_blank"><i class="fa fa-github"></i></a></li>
      </ul>
    </div>
  </aside>
  <main>
    <nav>
      <a href="http://littlezz.github.io">Home</a>
      <a href="/categories">Category</a>
      <a href="/tags">Tags</a>
      <a href="http://littlezz.github.io/feeds/all.atom.xml">Atom</a>
    </nav>

<article>
  <header>
    <h2><a href="http://littlezz.github.io/dui-numpyde-yi-xi-lie-shi-yan.html#dui-numpyde-yi-xi-lie-shi-yan">对numpy的一系列实验</a></h2>
    <p>
      Posted on Thu 08 December 2016 in <a href="http://littlezz.github.io/category/python.html">Python</a>
      &#8226; Tagged with
      <a href="http://littlezz.github.io/tag/python.html">python</a>,      <a href="http://littlezz.github.io/tag/numpy.html">numpy</a>    </p>
  </header>
  <div>
      <p>本文主要总结了如何把numpy计算速度优化100倍的过程。  </p>
<h2 id="_1"><a name="user-content-_1" href="#_1" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>简介</h2>
<p>最近要对图片做二值化， 参照<a href="http://people.scs.carleton.ca/~roth/iit-publications-iti/docs/gerh-50002.pdf">Adaptive Thresholding Using the Integral Image</a> 这篇论文， 可是Python的for循环非常的慢，单纯的翻译伪代码实现起来速度要比C慢接近100倍， 论文上的实现对640x480的图片用时大概为15ms， 接下来我们要一步步从最初的慢100倍优化到和C一样快， 以及最后再比它快一点点。</p>
<h2 id="_2"><a name="user-content-_2" href="#_2" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>算法</h2>
<p>首先， 介绍一下 Adaptive Thresholding Using the Integral Image 这篇论文， 论文很简单， 对一个点周围的一片区域取平均值， 如果该点低于平均值的85%， 就设为黑， 否则为白色。 论文主要是用累积和来改进取一片区域平均值的速度。 <br />
过程为水平方向做一次累积和， 垂直方向做一次累积和， 这样每一个点就表示其左上角的区域的和， 于是要计算一个矩形（a, b, c, d), 其区域上的和就是 d - b -c + a. <br />
原始的扫描区域的每一个点求和， 时间是O(n * n * boxsize * boxsize)， 现在变成了常数时间。  </p>
<h2 id="_3"><a name="user-content-_3" href="#_3" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>直观实现</h2>
<p>首先我们直接照着原理实现，理论是最快的<br />
（然而实际是最慢的） </p>
<p><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">intuitive_method</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="p">,</span> <span class="n">set_value</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">boxsize</span><span class="p">):</span>
    <span class="n">mat</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">T</span>
    <span class="n">integral_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">w</span><span class="p">):</span>
        <span class="n">csum</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">h</span><span class="p">):</span>
            <span class="n">csum</span> <span class="o">+=</span> <span class="n">mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">integral_map</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">integral_map</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">csum</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">integral_map</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">csum</span>

    <span class="n">half_s</span> <span class="o">=</span> <span class="p">(</span><span class="n">boxsize</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">w</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">h</span><span class="p">):</span>
            <span class="n">x1</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">half_s</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">x2</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">half_s</span><span class="p">,</span> <span class="n">w</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">y1</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">j</span><span class="o">-</span><span class="n">half_s</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">y2</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="n">half_s</span><span class="p">,</span> <span class="n">h</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">field_sum</span> <span class="o">=</span> <span class="n">integral_map</span><span class="p">[</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">]</span> <span class="o">-</span> <span class="n">integral_map</span><span class="p">[</span><span class="n">x1</span><span class="p">,</span> <span class="n">y2</span><span class="p">]</span> <span class="o">-</span> <span class="n">integral_map</span><span class="p">[</span><span class="n">x2</span><span class="p">,</span> <span class="n">y1</span><span class="p">]</span> <span class="o">+</span> <span class="n">integral_map</span><span class="p">[</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">]</span>
            <span class="n">count</span> <span class="o">=</span>  <span class="p">(</span><span class="n">x2</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">y2</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">count</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span> <span class="o">&lt;</span> <span class="n">field_sum</span><span class="o">*</span><span class="p">(</span><span class="mi">100</span><span class="o">-</span><span class="n">threshold</span><span class="p">):</span>
                <span class="n">ret</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">set_value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ret</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">set_value</span> <span class="o">^</span> <span class="mi">255</span>

    <span class="k">return</span> <span class="n">ret</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
</pre></div>
<br />
mat是我们的图片矩阵， boxsize是区域的长度， 必须是奇数。 <br />
每个点都在周围取一个boxsize长度的矩形， 要特别处理边界， 让他不要超出累积矩阵。<br />
很直观的代码， 纯翻译自论文里面的伪代码。  </p>
<p>看看速度：</p>
<p><div class="highlight"><pre><span></span>⇒  python3 implement.py
Image shape 640x480
intuitive_method take 1658.280885 ms  
</pre></div>
<br />
1600ms, （怎么和说好的15ms不一样）。</p>
<h2 id="_4"><a name="user-content-_4" href="#_4" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>改进的直观方法</h2>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">optimized_intuitive_method</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="p">,</span> <span class="n">set_value</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">boxsize</span><span class="p">):</span>
    <span class="n">mat</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">T</span>
    <span class="n">integral_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">integral_map</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">integral_map</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">integral_map</span><span class="p">)</span>

    <span class="n">half_s</span> <span class="o">=</span> <span class="n">boxsize</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span>
    <span class="n">inv_value</span> <span class="o">=</span> <span class="n">set_value</span> <span class="o">^</span> <span class="mi">255</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">w</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">h</span><span class="p">):</span>
            <span class="n">x1</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">half_s</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">x2</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">half_s</span><span class="p">,</span> <span class="n">w</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">y1</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">j</span> <span class="o">-</span> <span class="n">half_s</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">y2</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="n">half_s</span><span class="p">,</span> <span class="n">h</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">field_sum</span> <span class="o">=</span> <span class="n">integral_map</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">)</span> <span class="o">-</span> <span class="n">integral_map</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y2</span><span class="p">)</span> <span class="o">-</span> <span class="n">integral_map</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y1</span><span class="p">)</span> <span class="o">+</span> <span class="n">integral_map</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">)</span>
            <span class="n">count</span> <span class="o">=</span>  <span class="p">(</span><span class="n">x2</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">y2</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">mat</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="o">*</span> <span class="n">count</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span> <span class="o">&lt;</span> <span class="n">field_sum</span><span class="o">*</span><span class="p">(</span><span class="mi">100</span><span class="o">-</span><span class="n">threshold</span><span class="p">):</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">itemset</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">set_value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">itemset</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">inv_value</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ret</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
</pre></div>


<p>Numpy提供了item和itemset方法来加速对矩阵上单个点的操作。<br />
同时两次累积和实际可以用可以用<code>np.cumsum</code>来计算， 但是这里有一个小细节，<br />
单纯的使用两次<code>a=np.cumsum(...)</code>会额外进行一次内部的内存拷贝， 我们要指定<code>out</code>参数来阻止多余的内存拷贝.</p>
<p>在计算half_s的时候， 使用移位<code>boxsize &gt;&gt; 1</code>来加速。  </p>
<p><div class="highlight"><pre><span></span>⇒  python3 implement.py
Image shape 640x480
optimized_intuitive_method take 823.928799 ms
</pre></div>
<br />
快了一倍， 但是还是不够</p>
<h2 id="_5"><a name="user-content-_5" href="#_5" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>猥琐法</h2>
<p>不妨让我们直接退化到累积和的优化之前，纯粹的暴力计算，所有计算都交给opencv， 看看会发生什么事情。</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">opencv_way</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="p">,</span> <span class="n">set_value</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">boxsize</span><span class="p">):</span>
    <span class="n">mat</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">inv_value</span> <span class="o">=</span> <span class="n">set_value</span> <span class="o">^</span> <span class="mi">255</span>
    <span class="n">kernel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">boxsize</span><span class="p">,</span> <span class="n">boxsize</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="mi">100</span><span class="o">-</span><span class="n">threshold</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span> <span class="o">/</span> <span class="p">(</span><span class="n">boxsize</span><span class="o">*</span><span class="n">boxsize</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">filter2D</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">kernel</span><span class="p">)</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mat</span> <span class="o">&lt;</span> <span class="n">result</span><span class="p">,</span> <span class="p">[</span><span class="n">set_value</span><span class="p">],</span> <span class="p">[</span><span class="n">inv_value</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">ret</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
</pre></div>


<p>这是时间：</p>
<div class="highlight"><pre><span></span>⇒  python3 implement.py
Image shape 640x480
opencv_way take 35.920926 ms
</pre></div>


<p>好了， 可以全剧终了。<br />
简单的6行代码， 纯粹的暴力美学。 速度快了40倍。（你学到了么？）<br />
这里我们借助opencv 的 <code>filter2D</code>方法， 自己定义了一个kernel， 用来求一个点周围区域的平均值， 接下来的计算就全部交给opencv了。 <br />
关于opencv， 有一点需要补充， <strong>opencv表示， numpy是辣鸡， 请多使用opencv自带的函数</strong>。  </p>
<h2 id="_6"><a name="user-content-_6" href="#_6" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>向量化</h2>
<p>还不能全剧终， 接下来是重点， numpy是为矩阵计算而生的， 我们前面一直按照C的思维来对单个点做操作， 而且for循环的存在导致速度下降太多， 接下来我们要寻求把for循环替换掉， 改成向量的计算。</p>
<p>对于numpy来说， 比如我有两个2维矩阵A和B， 要计算两个矩阵上所有点的差， 从速度上来说， </p>
<div class="highlight"><pre><span></span>A - B &gt; A[i] - B[i] &gt; A[i,j] - B[i,j]
</pre></div>


<p>我们现在希望把所有的for循环， 替换为矩阵的计算 <code>A - B</code></p>
<p>一开始的时候我想到利用一次for循环， 从上往下计算两行之间的值， 接着从左往右计算每一列的值， 但是这样只能去掉一个for循环， 后来我想了2个晚上， 想通了实际上所有等距离点操作都可以转化为等距离的向量操作， 进而可以通过构造矩阵来进行矩阵间的操作。  </p>
<p>对于之前的代码， 计算累积和部分已经很好了， 关键之后的计算， 代码冗余， 效率低下。  </p>
<p>其中造成整个for循环存在的关键因素是下面这句代码</p>
<p><div class="highlight"><pre><span></span>integral_map[x2, y2] - integral_map[x1, y2] - integral_map[x2, y1] + integral_map[x1, y1]
</pre></div>
<br />
而实际上， 这些点之间是等距离的， （boxsize的距离）， 也就是说， 每一个点对应的x1， x2, y1, y2 都是固定的， 我们可以构造出4个矩阵， 分别向左上， 右上， 左下， 右下位移一段距离， <br />
这样就可以吧整个for循环计算化简成  </p>
<div class="highlight"><pre><span></span>D + A - C - B
</pre></div>


<p>那么怎么构造出这些矩阵呢？<br />
想象一下， 把<code>integral_map[x1, y1]</code>当成一个集合， 记为A， <code>integral_map[x1, y2]</code>的集合记为B， <code>integral_map[x2, y1]</code>的集合记为C，<code>integral_map[x2, y2]</code>记为D。   </p>
<p>以构造A为例， A实际上是对原先的矩阵向上和向左平移了一半的boxsize的距离， 比如对于矩阵右下角的点，A对应于 <code>integral_map[h-half_boxsize, w-half_boxsize]</code>  </p>
<p>但是对于左上角的点， 超出了累积矩阵的范围， 为了避免额外的对边界的判断， 我们要额外构造出边框。  </p>
<p>想象一下， 比如我们有一个5x5的矩阵， boxsize取3, </p>
<p><div class="highlight"><pre><span></span>  0 1 2 3 4
0 * * * * *
1 * * * * *
2 * * * * *
3 * * * * *
4 * * * * *
</pre></div>
<br />
计算 (2, 2) 的时候， 取 (1, 1), (1, 3)， （3，1）， （3，3）四个点<br />
计算(0,0)上的和的时候， 右下角取（1，1）， 左上角超出了边界，所以只能取（0，0）<br />
计算（0，1）的时候，右下角是（1，2） 但是左上角还是（0，0）    </p>
<p>所以我们可以构造出一个<code>(boxsize-1)/2</code> 长度的边框，边框上的值和边界的值一样。 这样我们可以通过平移得到ABCD四个矩阵， 而不用额外的边界判断。 </p>
<p><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">vector_method</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">set_value</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">boxsize</span><span class="p">):</span>
    <span class="n">inv_value</span> <span class="o">=</span> <span class="n">set_value</span> <span class="o">^</span> <span class="mi">255</span>
    <span class="n">integral_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

    <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">integral_map</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">integral_map</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">integral_map</span><span class="p">)</span>

    <span class="n">half_s</span> <span class="o">=</span> <span class="n">boxsize</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span>
    <span class="n">big_mat</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">copyMakeBorder</span><span class="p">(</span><span class="n">integral_map</span><span class="p">,</span> <span class="n">half_s</span><span class="p">,</span> <span class="n">half_s</span><span class="p">,</span> <span class="n">half_s</span><span class="p">,</span> <span class="n">half_s</span><span class="p">,</span> <span class="n">borderType</span><span class="o">=</span><span class="n">cv</span><span class="o">.</span><span class="n">BORDER_REPLICATE</span><span class="p">)</span>
    <span class="n">big_h</span><span class="p">,</span> <span class="n">big_w</span> <span class="o">=</span> <span class="n">big_mat</span><span class="o">.</span><span class="n">shape</span>
    <span class="c1"># 构造4个矩阵</span>
    <span class="c1"># top left</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">big_mat</span><span class="p">[:</span><span class="n">h</span><span class="p">,</span> <span class="p">:</span><span class="n">w</span><span class="p">]</span>
    <span class="c1"># bottom left</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">big_mat</span><span class="p">[</span><span class="n">big_h</span> <span class="o">-</span> <span class="n">h</span><span class="p">:,</span> <span class="p">:</span><span class="n">w</span><span class="p">]</span>
    <span class="c1"># top right</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">big_mat</span><span class="p">[:</span><span class="n">h</span><span class="p">,</span> <span class="n">big_w</span> <span class="o">-</span> <span class="n">w</span><span class="p">:]</span>
    <span class="c1"># bottom right</span>
    <span class="n">D</span> <span class="o">=</span> <span class="n">big_mat</span><span class="p">[</span><span class="n">big_h</span> <span class="o">-</span> <span class="n">h</span><span class="p">:,</span> <span class="n">big_w</span> <span class="o">-</span> <span class="n">w</span><span class="p">:]</span>

    <span class="n">COUNT</span> <span class="o">=</span> <span class="n">get_count_matrix</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">boxsize</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">D</span> <span class="o">+</span> <span class="n">A</span> <span class="o">-</span> <span class="n">B</span> <span class="o">-</span> <span class="n">C</span><span class="p">)</span><span class="o">*</span><span class="p">((</span><span class="mi">100</span><span class="o">-</span><span class="n">threshold</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span> <span class="o">/</span> <span class="n">COUNT</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mat</span> <span class="o">&lt;</span> <span class="n">result</span><span class="p">,</span> <span class="p">[</span><span class="n">set_value</span><span class="p">],</span> <span class="p">[</span><span class="n">inv_value</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">ret</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
</pre></div>
<br />
但是， 现在还有一道阴影笼罩着我们， 我们没有办法得到窗口的实际大小。 边界附近的点上的窗口是变化的， 我们得额外构造出一个矩阵<code>COUNT</code>来表示每个点上的窗口大小。  </p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_count_matrix</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">boxsize</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    矩阵上每个点的值表示该点上的窗口覆盖的总点数。</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># faster than (boxsize-1) // 2</span>
    <span class="n">half_boxsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">boxsize</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span>

    <span class="c1"># 窗口的真正大小并不是boxsize！而是（boxsize - 1）！</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">boxsize</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">boxsize</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">half_boxsize</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">half_boxsize</span>
        <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="n">A</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="n">B</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="n">B</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">return</span> <span class="n">A</span> <span class="o">*</span> <span class="n">B</span>
</pre></div>


<p>看一下所需的时间</p>
<div class="highlight"><pre><span></span>⇒  python3 implement.py
Image shape 640x480
vector_method take 22.166661 ms
</pre></div>


<p>现在我们比最初快了80倍， 已经接近论文上的理论速度了， 但是<code>get_count_matrix</code>函数显得非常的力不从心， 还可以寻找优化的办法。  </p>
<h2 id="_7"><a name="user-content-_7" href="#_7" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>优化后的向量化方法</h2>
<p>回想之前的整个过程， 我们对边界的处理实际上过于保守了， 导致计算窗口覆盖点数的时候过于小心翼翼了(不然boxsize-1是怎么得出来的， 都是泪啊)。</p>
<p>我们可以在计算累积和之前先对边界翻折来进行填充， 之后再对扩展后的矩阵进行累积和，这样可以省略掉<code>get_count_matrix</code>函数， 统一采用<code>(boxsize-1)*(boxsize-1)</code>。  </p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">optimized_vector_method</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">set_value</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">boxsize</span><span class="p">):</span>
    <span class="n">inv_value</span> <span class="o">=</span> <span class="n">set_value</span> <span class="o">^</span> <span class="mi">255</span>
    <span class="n">half_s</span> <span class="o">=</span> <span class="n">boxsize</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span>
    <span class="n">integral_map</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">copyMakeBorder</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">half_s</span><span class="p">,</span> <span class="n">half_s</span><span class="p">,</span> <span class="n">half_s</span><span class="p">,</span> <span class="n">half_s</span><span class="p">,</span> <span class="n">borderType</span><span class="o">=</span><span class="n">cv</span><span class="o">.</span><span class="n">BORDER_REFLECT101</span><span class="p">)</span>
    <span class="n">integral_map</span> <span class="o">=</span> <span class="n">integral_map</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>

    <span class="n">integral_map</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">integral_map</span><span class="p">)</span>
    <span class="n">integral_map</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">integral_map</span><span class="p">)</span>

    <span class="n">big_h</span><span class="p">,</span> <span class="n">big_w</span> <span class="o">=</span> <span class="n">integral_map</span><span class="o">.</span><span class="n">shape</span>
    <span class="c1"># 构造4个矩阵</span>
    <span class="c1"># top left</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">integral_map</span><span class="p">[:</span><span class="n">h</span><span class="p">,</span> <span class="p">:</span><span class="n">w</span><span class="p">]</span>
    <span class="c1"># bottom left</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">integral_map</span><span class="p">[</span><span class="n">big_h</span> <span class="o">-</span> <span class="n">h</span><span class="p">:,</span> <span class="p">:</span><span class="n">w</span><span class="p">]</span>
    <span class="c1"># top right</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">integral_map</span><span class="p">[:</span><span class="n">h</span><span class="p">,</span> <span class="n">big_w</span> <span class="o">-</span> <span class="n">w</span><span class="p">:]</span>
    <span class="c1"># bottom right</span>
    <span class="n">D</span> <span class="o">=</span> <span class="n">integral_map</span><span class="p">[</span><span class="n">big_h</span> <span class="o">-</span> <span class="n">h</span><span class="p">:,</span> <span class="n">big_w</span> <span class="o">-</span> <span class="n">w</span><span class="p">:]</span>

    <span class="c1"># COUNT = get_count_matrix(w, h, boxsize)</span>
    <span class="n">COUNT</span> <span class="o">=</span> <span class="p">(</span><span class="n">boxsize</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">D</span> <span class="o">+</span> <span class="n">A</span> <span class="o">-</span> <span class="n">B</span> <span class="o">-</span> <span class="n">C</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="mi">100</span><span class="o">-</span><span class="n">threshold</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">/</span> <span class="n">COUNT</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mat</span> <span class="o">&lt;</span> <span class="n">result</span><span class="p">,</span> <span class="p">[</span><span class="n">set_value</span><span class="p">],</span> <span class="p">[</span><span class="n">inv_value</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">ret</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
</pre></div>


<p>看看计算时间，  </p>
<div class="highlight"><pre><span></span>⇒  python3 implement.py
Image shape 640x480
optimized_vector_method take 10.539570999999999 ms
</pre></div>


<p>比最初快了150倍， 而且超过了论文上的C语言实现的15ms的时间。  </p>
<h2 id="_8"><a name="user-content-_8" href="#_8" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>总结分析</h2>
<p>对于最后的这个方法， 需要额外解释一下为什么会比论文快。<br />
其中一个是CPU的原因， 论文上用的是4核奔腾3.4Ghz的CPU，而我自己的是i5 2.7GHz。<br />
i5应该是快一些的， （我猜）</p>
<p>之后是在对窗口大小的计算时间上， 因为我们通过填充扩展矩阵， 使得每一个点的窗口大小都是固定的值， 比论文中的方法省去了多余的窗口大小计算和多余的边界判断。<br />
但是扩展矩阵在计算累积和的时候有额外的时间消耗， boxsize默认采用边长的1/8， <br />
构造后的矩阵比原先大了 81/64 倍的大小。<br />
不过在之后的计算中并没有额外的消耗。  </p>
<p>再次， 虽然我们构造出了4个矩阵ABCD， 但是实际上没有对内存做拷贝， ABCD都是累积和矩阵上的映射， 没有对内存中的实际数据做拷贝。</p>
<p>最后，   </p>
<p><div class="highlight"><pre><span></span>integral_map = integral_map.astype(np.uint32)
</pre></div>
<br />
我指定了矩阵中的元素的大小， 统一为无符号32位， 速度又得到了一定的提升。<br />
但是uint32有其局限， 只能存下2^32次方的数据， 灰度图的每一个点的最大取值是2^8， 于是uint32的累积矩阵只能存下2^24个像素点， 然而由于填充了边框， 矩阵比实际大了81/64， 约1.266倍， <code>sqrt(2^24/1.266) = 3640</code>,  所以只能处理3640x3640的图片， 但是从平均情况来说， 每一个点平均取2^7， 于是我们可以处理最大5148x5148的图片。</p>
<p>到此， 完成了从最初的1600ms到10ms的优化。  </p>
<h2 id="_9"><a name="user-content-_9" href="#_9" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>彩蛋</h2>
<p>混沌邪恶  </p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">cv2</span> <span class="kn">as</span> <span class="nn">cv</span>

<span class="k">def</span> <span class="nf">wtf</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="p">,</span> <span class="n">set_value</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">boxsize</span><span class="p">):</span>
    <span class="c1"># 这才叫Python嘛！</span>
    <span class="k">return</span> <span class="n">cv</span><span class="o">.</span><span class="n">adaptiveThreshold</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="n">cv</span><span class="o">.</span><span class="n">ADAPTIVE_THRESH_GAUSSIAN_C</span><span class="p">,</span> <span class="n">cv</span><span class="o">.</span><span class="n">THRESH_BINARY_INV</span><span class="p">,</span> <span class="n">boxsize</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
</pre></div>


<p>咕咕咕？？？<br />
我选择opencv自带的局部自适应高斯二值化</p>
<div class="highlight"><pre><span></span>⇒  python3 implent.py
Image shape 640x480
wtf take 8.884578000000001 ms
</pre></div>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://littlezz.github.io/ji-yi-ci-fu-wu-qi-bei-bao-po-hou-zai-hou-zhong-jian-ssde-jing-li.html#ji-yi-ci-fu-wu-qi-bei-bao-po-hou-zai-hou-zhong-jian-ssde-jing-li">记一次服务器被爆破后灾后重建ss的经历</a></h2>
    <p>
      Posted on Fri 18 November 2016 in <a href="http://littlezz.github.io/category/code.html">Code</a>
    </p>
  </header>
  <div>
      <h2 id="_1"><a name="user-content-_1" href="#_1" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>疑似被黑</h2>
<p>2年前和基友合力租了一台服务器用于搭建ss服务， 当年啥也不懂， 系统选的是fedora， yum install fail2ban之后主要精力就是折腾ss， 配了supervisord， 编译了hybla的模块， 就不管了。  </p>
<p>2年来一直没出什么大事， 偶尔大面积100%丢包过一下就好了， 没当回事。  </p>
<p>直到昨天因为系统更新准备重新编译hybla， 登录上去顺便用网上抄了的命令查看了一下当前连接量， </p>
<div class="highlight"><pre><span></span>netstat -an | grep 443 | grep ESTABLISHED | wc -l
</pre></div>


<p>大的惊人， 开始慌了。  </p>
<p>检查log日志， 发现大量</p>
<div class="highlight"><pre><span></span>2016-11-16 01:16:01 ERROR can not parse header when handling connection from ::ffff:&lt;ip&gt;:&lt;port&gt;
</pre></div>


<p>反查这些ip， 发现都不是我们自己的ip。<br />
我估计是被爆破了， 但是我端口用的是443， 所以也不太好确定是不是真的被爆破。<br />
之后就是ban ip， 换端口， 改密码。  </p>
<p>接着开始考虑服务器本身有没有被攻破， 看了一下ssh的22端口， 发现有其他的ip在建立连接， 到这里我都没有特别慌张， 我想， 我还有fail2ban呢。  </p>
<p>检查了一下我的fail2ban， 发现处于开启失败状态。<br />
顺带， ssh服务没换端口， 允许root账号登录， 允许密码登录。</p>
<p>『卧槽， 精彩了』  </p>
<p>赶紧联系大腿。</p>
<p>先打<code>w</code>命令， 一片空白， 一般登录了的话至少有自己一个人， 现在什么也没有， 六神表示<code>w</code>估计被改了， 可能是被rootkit了， rootkit了的话基本就很难看出其他的东西了。  </p>
<p>往后是一些挣扎， 检查<code>ps -aux</code>， 看不出来。<br />
检查<code>who -a /var/log/wtmp</code>, 看一下登录的信息， 看不出来。<br />
检查bash_history, zsh_history， 根本懒得看了。  </p>
<p>淦他娘啊， 我选择重装！  </p>
<h2 id="_2"><a name="user-content-_2" href="#_2" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>灾后重建</h2>
<p>这次选了ubuntu， 而且有经验了。  </p>
<ul>
<li>
<p>先装<code>zsh</code>, <code>apt-get install zsh</code>  </p>
</li>
<li>
<p>建立用户, 指定shell为zsh， <code>useradd youruser -m -s /bin/zsh</code></p>
</li>
<li>
<p>上传公钥， 通过 <code>ssh-copy-id</code> 命令。  </p>
</li>
<li>
<p>更改ssh的配置， 改端口， 关root登录， 关密码登录。  </p>
<p><div class="highlight"><pre><span></span>PermitRootLogin no
Port 12345
PasswordAuthentication no
</pre></div>
<br />
* 重启ssh服务。  </p>
</li>
<li>
<p>安装 <code>denyhosts</code>, <code>apt-get install denyhosts</code>  </p>
</li>
<li>
<p><code>oh-my-zsh</code></p>
<div class="highlight"><pre><span></span>apt-get install git
sh -c <span class="s2">&quot;</span><span class="k">$(</span>wget https://raw.githubusercontent.com/robbyrussell/oh-my-zsh/master/tools/install.sh -O -<span class="k">)</span><span class="s2">&quot;</span>
</pre></div>


</li>
</ul>
<h2 id="ss"><a name="user-content-ss" href="#ss" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>配置ss</h2>
<h4 id="pip-shadowsocks"><a name="user-content-pip-shadowsocks" href="#pip-shadowsocks" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>更新系统， 装<code>pip</code>， <code>shadowsocks</code></h4>
<div class="highlight"><pre><span></span>apt-get install python-pip
pip install -U pip
pip install shadowsocks
</pre></div>


<h4 id="libsodium"><a name="user-content-libsodium" href="#libsodium" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>安装密码库， 安装<code>libsodium</code>依赖</h4>
<div class="highlight"><pre><span></span>apt-get install python-m2crypto
apt-get install libsodium18
pip install M2Crypto
</pre></div>


<h4 id="etcshadowsocksjson"><a name="user-content-etcshadowsocksjson" href="#etcshadowsocksjson" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>配置<code>/etc/shadowsocks.json</code></h4>
<div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;server&quot;</span><span class="p">:</span><span class="s2">&quot;::&quot;</span><span class="p">,</span>
    <span class="nt">&quot;server_port&quot;</span><span class="p">:</span><span class="mi">8899</span><span class="p">,</span>
    <span class="nt">&quot;local_address&quot;</span><span class="p">:</span> <span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span>
    <span class="nt">&quot;local_port&quot;</span><span class="p">:</span><span class="mi">1080</span><span class="p">,</span>
    <span class="nt">&quot;password&quot;</span><span class="p">:</span><span class="s2">&quot;password&quot;</span><span class="p">,</span>
    <span class="nt">&quot;timeout&quot;</span><span class="p">:</span><span class="mi">100</span><span class="p">,</span>
    <span class="nt">&quot;method&quot;</span><span class="p">:</span><span class="s2">&quot;&lt;choose a method&gt;&quot;</span><span class="p">,</span>
    <span class="nt">&quot;fast_open&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="nt">&quot;workers&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="nt">&quot;user&quot;</span><span class="p">:</span><span class="s2">&quot;nobody&quot;</span>
<span class="p">}</span>
</pre></div>


<p>服务器参数设置<code>"::"</code>可以同时监听ipv4和ipv6, user设置nobody权限， 选一个加密方式， 另外最新是可以打开OTA来防止被攻击， 但是需要客户端也支持OTA。 </p>
<p>除此以外， 还可以用提供的 <a href="https://github.com/shadowsocks/shadowsocks/blob/master/utils/autoban.py">autoban.py</a> 来ban ip,使用方法参考<a href="https://github.com/shadowsocks/shadowsocks/wiki/Ban-Brute-Force-Crackers">Ban Brute Force Crackers</a> .<br />
注意到同时监听ipv4和ipv6的时候， 这个代码提取ip的方式有问题，要改一下，<br />
第41行改成  </p>
<div class="highlight"><pre><span></span>ip = line.split()[-1].split(&#39;:&#39;)[-2]
</pre></div>


<p><strong>（小心不要把自己ban了</strong></p>
<p><br>  </p>
<h4 id="_3"><a name="user-content-_3" href="#_3" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>关于优化</h4>
<p>参考  <a href="https://github.com/iMeiji/shadowsocks_install/wiki/shadowsocks-optimize">shadowsocks-optimize</a>, 不重复了  </p>
<h4 id="_4"><a name="user-content-_4" href="#_4" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>配置开机自启动</h4>
<p>rc.local ubuntu用不了， 需要自己写一个<code>shadowsocks.service</code>:<br />
在<code>/etc/systemd/system</code>下建立一个文件， 比如<code>shadowsocks.service</code>， 写入如下内容  </p>
<div class="highlight"><pre><span></span><span class="k">[Unit]</span>
<span class="na">Description</span><span class="o">=</span><span class="s">run ssserver on background</span>

<span class="k">[Service]</span>
<span class="na">Type</span><span class="o">=</span><span class="s">forking</span>
<span class="na">ExecStart</span><span class="o">=</span><span class="s">/usr/local/bin/ssserver -c /etc/shadowsocks.json -d restart</span>
<span class="na">ExecStop</span><span class="o">=</span><span class="s">/usr/local/bin/ssserver -c /etc/shadowsocks.json -d stop</span>

<span class="k">[Install]</span>
<span class="na">WantedBy</span><span class="o">=</span><span class="s">multi-user.target</span>
</pre></div>


<p>参考： <br />
<a href="https://unix.stackexchange.com/questions/47695/how-to-write-startup-script-for-systemd">how-to-write-startup-script-for-systemd</a></p>
<p><a href="https://www.freedesktop.org/software/systemd/man/systemd.service.html">systemd.service.html</a></p>
<p>按说明， <code>Type</code>选<code>forking</code>而不是<code>simple</code>。</p>
<p>之后可以用<code>systemctl start shadowsocks</code> 和<code>systemctl stop shadowsocks</code> 开关ss.  </p>
<p>使用 <code>systemctl enable shadowsocks</code> 让ss开机启动。</p>
<h2 id="_5"><a name="user-content-_5" href="#_5" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>总结</h2>
<p><del>在被日中成长</del>。  </p>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://littlezz.github.io/lan.html#lan">懒</a></h2>
    <p>
      Posted on Wed 17 August 2016 in <a href="http://littlezz.github.io/category/diary.html">diary</a>
      &#8226; Tagged with
      <a href="http://littlezz.github.io/tag/ri-ji.html">日记</a>,      <a href="http://littlezz.github.io/tag/xia-che.html">瞎扯</a>,      <a href="http://littlezz.github.io/tag/xiao-jie.html">小结</a>    </p>
  </header>
  <div>
      <p><img alt="" src="../images/need_fix.jpg" />  </p>
<p>最近太懒了， 之前写的几个练手的项目， 有一些没有放到github上面就已经弃坑了， 至于一些开的坑， 也处于长期不填的状态。  </p>
<p>最近在准备写一个即时聊天的网站来练手，前端用reactjs， 后端是aiohttp， 数据库mongodb，  主要是想体验一把分布式的Websocket 和Python3.5 的<code>await/async</code>语法的。但是按现在的进度看来要花大把的时间在前端上面了， 我一年前不知道为什么两个元素会上下排列， 一年后还是不知道为什么。  </p>
<p>前端， 总是给我一种五五开的『这他妈是什么， 这他妈又是什么』的感觉。</p>
<p>不久前写过一个chrome的插件<a href="https://github.com/littlezz/PixivFast">PixivFast</a>， 用来让我在p站刷图时可以不用点开大图之后再右键另存为， 而是按一下<code>s</code>就可以弹出下载大图的会话框。 实用， 但是没放到google商店上， 而且我还想着再加一个同时给10分评分的功能， 于是就一直拖着。目前有一名忠实的用户——我自己， 不过由于没有在google商店上面发布， 每次重启浏览器都得重新安装插件， 就现状看来， 这个『忠实』的用户也快叛变了。  </p>
<p>还有一个备份A岛讨论串的爬虫， <a href="https://github.com/littlezz/island-backup">island-backup</a>, 用aiohttp写的。当初野心勃勃， 如今也只是剩下几个自己开的issue没关， kukuku岛禁用api接口之后我懒得再管, 于是现在只能用于主岛。甚至github上面代码到了v1.1.2， 但是pypi上面还是停留在v1.0.1。<br />
懒到不想打包。  </p>
<p>其实api接口禁用之后解析html就好了， 懒。 我之前写过一个搜索出A岛回复数超过一定量的串的程序， 当时是有精力啊， 支持A岛， 哭哭哭岛， 备胎岛， 甚至是K岛， 里面有socks的代理设置， 而且还图形化了，用的是自带的tk。 然后呢？mac上面的tk有问题， 触摸板双指滑动tk就崩， 我自己的mac上面下载了新的tk， 没有问题，  后来兴致勃勃的跑去给蛋蛋试用， 他从github上克隆好程序装好所需的依赖， 启动之后双指一上滑， Duang！ </p>
<p>我和他解释啊， 这不是我的锅啊， 这是tk的锅啊， tk的锅啊， 底层的锅啊， 我救不了啊。 </p>
<p>你要不装个新的tk试试？ </p>
<p>他给了我一个关爱智障的眼神。  </p>
<p><img alt="" src="../images/2.jpg" />  </p>
<p>这个项目后来也不了了之了， 我自己都不用。  </p>
<p>后来还写了一个<a href="https://github.com/littlezz/ESL-Model">ESL-Model</a>, 这东西我都不想说， 现在都快成黑历史了， 我原先计划把那本 The Elements of statistical Learning 上面的方法全部实现一遍的， 后来大概止步于卷积神经网络的那个patch和步长不能刚好走完一层， 比如书上说patch 3x3, 每次走两格， 但是那一层是16x16， 不能刚好走完啊。我看那个cs231也是刚好能够走完一层的， 于是我就懵逼了啊。<br />
彼时日常生活也发生了些事情， 我没有精力再搞， 于是放了两个月， 到得现在大概是放弃了。 彻底是一个坑了。</p>
<p>唉都是借口， 都是懒。  </p>
<p>我还是计划一下之后怎么办吧，虽然都是练手， 没什么时间的要求， 但是老拖下去也不是办法。  </p>
<p>至少：  </p>
<ul>
<li>pixivfast 给弄完交钱注册个账号放到google商店上。  </li>
<li>island_backup 把issue清了。  </li>
<li>计划的练手的项目给写了。  </li>
</ul>
<p>先这样吧。</p>
<p>2016年08月17日18:17:19</p>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://littlezz.github.io/hui-jia.html#hui-jia">回家</a></h2>
    <p>
      Posted on Sun 05 June 2016 in <a href="http://littlezz.github.io/category/diary.html">diary</a>
      &#8226; Tagged with
      <a href="http://littlezz.github.io/tag/ri-ji.html">日记</a>,      <a href="http://littlezz.github.io/tag/li-ren-ge.html">里人格</a>,      <a href="http://littlezz.github.io/tag/xia-che.html">瞎扯</a>    </p>
  </header>
  <div>
      <p>我在上课。<br />
如同之前我上过的无数的课一样， 我完全没有在听。  </p>
<p>老师要求我们在书本上做题， 之后使用像超市里面的条形码扫描器一样的机器在书本上一扫， 平时分就出来了。  </p>
<p>当然， 这种机器看上去高级， 但总是给人一种玩具的感觉。有些人的分数就是飘忽不定， 一会儿是二十几分， 一会儿是六十几分， 这取决于使用扫描器时的角度， 是个依赖耐心和运气的活儿。   <br />
不过使用者虽然有耐心， 但是其他同学还在等着用啊， 于是乱糟糟的， 催别人快一些的， 拿高分的发表扫描器使用经验谈的， 拿低分大叫不公平等着再试一次的。  </p>
<p>看够了， 我才发现我不知道教材是什么， 看看邻座的，还好， 我桌子上有了一本， 可是完全不知道要写哪里。<br />
此时老师已经拿着扫描仪走到我旁边了， 我还没有找到对应的页数， 一把抽过邻座的书， 74页， 我看了一下自己的书， 第71页， 赶紧一翻， 老师也在这时走到了我身旁。  </p>
<p>我希望他没有看到我空空如也的书本， 对他说先检查邻座的吧。  </p>
<p>末了， 老师说时间不够了， 没有检查的同学下课了过去找他。我松了一口气， 赶紧对着邻座的书本抄， 题目是填写一个巨大且数目繁多的表格。  </p>
<p>放学后走在回家的路上， 我带着耳机， 放着the pillows的《one life》，和一个女生并肩走着， 我低着头看我的脚抬起又落下， 配合着节拍， 正当我觉得风景正好， 晚霞染红了半片天， 心情舒畅， 斗志昂扬的时候， 我想起这样带着耳机和一个女孩走路不太礼貌， 继而我突然想到我忘记去给老师检查我的作业了。</p>
<p>于是事情最终演变成了我摘下耳机， 停下了脚步， 在兴奋劲还没有散去的脸上新添了一份略带惶恐的表情：『完了， 我忘记给老师检查了， 平时分没有了。  』</p>
<p>女孩或许说了些什么， 我没在听， 但是我才注意到我喜欢这个女孩， 但是他是不是我的女朋友呢， 好像也不是， 我们可能是在恋爱期吧。  </p>
<p>我觉得没有什么比现在和女孩一起走在回家的路上更重要的了， 瞬间忘光了检查作业的事情， 毕竟， 现在回学校也没有什么用了。  </p>
<p>到了一处池塘， 池塘旁边放满了五花八门的脸盆和塑料桶。 这个池塘里面有各种各样的鱼， 以黑色的草鱼为主。 一个无主的池塘， 鱼儿平时可能就吃一些水草吧， 所以鱼饵一下去， 立马咬钩， 但是钓上来的鱼却总是又肥又大， 池塘旁边的各式各样的盆和桶用于给垂钓者临时存放钓上来的鱼， 偶尔来得早了还能发现几根普通的『随手』杆。  总之， 一个免费且设施齐全的自助鱼塘。  </p>
<p>我们商量着钓一条鱼回去， 取了一根鱼竿， 立马就钓上来了一条， 这时我才发现没有准备好保存鱼的桶。  </p>
<p>我用手握着黏糊糊的挣扎着的鱼， 问女孩， 你愿意拿着鱼还是愿意打一桶水？  </p>
<p>女孩看着鱼， 不语。  </p>
<p>都不愿意？  </p>
<p>女孩点了点头。  </p>
<p>我四处望了望， 看到一个老同学也在钓鱼， 身旁放着一个盆和一个细长的桶， 看来他今天收获不小。<br />
我走到同学的身旁， 向他表达了暂时存放一下我的鱼的请求， 他同意了。 我开始小小翼翼从鱼嘴上取下带着倒刺的鱼钩。 从它被钓上来开始已经过去一段时间了， 它在我手里的挣扎幅度越来越小， 可是到现在我也还是没能取下鱼钩， 最后， 鱼不动了， 眼看着是要不活了。这时，我同学一把夺过我手里的鱼， 另一只手拉住鱼线， 使劲一拔， 鱼钩连同着半片鱼唇一同飞出。<br />
他将鱼还给了我， 那半片鱼唇飞到天上的场景还历历在目， 我问他， 这样会不会太粗暴了， 他笑道， 鱼哪懂？  </p>
<p>我把鱼放到了水里， 可是它一动也不动了。<br />
死了么？我问道。<br />
同学瞟了一眼， 没事， 命硬着呢。  </p>
<p>过了一会儿， 鱼动了一下， 好像是打了一个寒颤， 之后又欢快的游了起来。  </p>
<p>放下心后， 我去到存放木桶的地方， 发现脸盆和木桶早已取尽， 今天来钓鱼的人很多，这下我无计可施了， 想了想， 去向刚才的同学借那个细长的木桶吧。  </p>
<p>来来回回了好几趟， 终于可以把鱼带回去了， 我把细长的木桶侵入水里， 抽出来时觉得格外的轻， 定睛一看， 发现下面打满了洞， 这哪里是木桶， 这是捞鱼用的捞勺啊。  </p>
<p>我独自苦笑， 转身寻找女孩， 向他举了举我的捞勺， 自嘲了几句。<br />
不远处， 女孩在和一个男生嬉笑着聊天， 她向我回了一个微笑， 接着继续投入到和男生的谈笑中， 我不知道他们在谈论什么， 我看到她笑得腰都弯了， 可是我听不到他们的声音，明明隔得不远。  </p>
<p>我突然发现天色已经很晚了， 晚霞早已不见， 留下雾沉沉的黑暗， 地上泛着些许的银光，透过雾气， 有些朦胧。  </p>
<p>我想， 回家吧。  </p>
<p><br></p>
<p>. . . . . .</p>
<p><br></p>
<p>和女孩站在电梯里， 看着电梯的门缓缓的关上——最终， 我还是发现了一个木桶， 带着鱼去女孩家吃晚饭了。—— 女孩在电梯楼层上面按了一下， 我才发现， 这栋楼好高， 我看到楼层按钮的左下角写着13， 我才想起我应该和我妈打个电话， 告诉他我不回去吃饭了。  </p>
<p>电梯开始上升， 我拨通了我妈的电话。<br />
『喂， 妈， 我今天晚上不回去吃饭了....我去， 去...额...』  </p>
<p>我把电话拿开， 扭过头来看着女孩， 向她问道：<br />
『你算是我的女朋友么？』  </p>
<p><br> </p>
<p>梦醒了。</p>
<p><br></p>
<p><em><p align='right'>2016年06月05日， 记昨天晚上做的一个梦。</p></em></p>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://littlezz.github.io/how-to-upload-package-to-pypi.html#how-to-upload-package-to-pypi">How to upload package to pypi</a></h2>
    <p>
      Posted on Sun 15 May 2016 in <a href="http://littlezz.github.io/category/python.html">Python</a>
      &#8226; Tagged with
      <a href="http://littlezz.github.io/tag/python.html">python</a>,      <a href="http://littlezz.github.io/tag/xiao-jie.html">小结</a>    </p>
  </header>
  <div>
      <h2 id="install-twine"><a name="user-content-install-twine" href="#install-twine" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>Install twine</h2>
<p><code>pip install twine</code></p>
<h2 id="init-file"><a name="user-content-init-file" href="#init-file" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>Init file</h2>
<p>First of all, make sure that the structure of project is correct. Says, your project code in a folder call 'foo', then you have <code>README</code> and some other files in the same level.  </p>
<p>For example, </p>
<div class="highlight"><pre><span></span>.
├── foo
│   └── a.py
└── readme.md
</pre></div>


<p>Secondly, add specify file to the root folder.  </p>
<ul>
<li>README.rst  </li>
<li>MANIFEST.in  </li>
<li>setup.py  </li>
<li>setup.cfg(option)</li>
</ul>
<p>pypi do not know markdown format readme, there is only rst format available.</p>
<h2 id="setuppy"><a name="user-content-setuppy" href="#setuppy" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>setup.py</h2>
<p>look at<br />
<a href="https://github.com/pypa/sampleproject/blob/master/setup.py">https://github.com/pypa/sampleproject/blob/master/setup.py</a></p>
<p>after finish <code>setup.py</code><br />
you can use   </p>
<p><code>pip install -e .</code><br />
install package locally on editable mode.<br />
It will also install dependency.  </p>
<h2 id="make-dist"><a name="user-content-make-dist" href="#make-dist" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>Make dist</h2>
<h3 id="build-source-distribution"><a name="user-content-build-source-distribution" href="#build-source-distribution" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>Build source distribution</h3>
<p>run<br />
<code>python setup.py sdist</code>  </p>
<h3 id="build-wheel"><a name="user-content-build-wheel" href="#build-wheel" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>Build wheel.</h3>
<p>If your code compat py2 and py3.<br />
<code>python setup.py bdist_wheel --universal</code>  </p>
<p>else, <br />
<code>python setup.py bdist_wheel</code>  </p>
<p>if your code is specify for some python version, add python tag in <code>setup.cfg</code>  </p>
<p>For example, if your code is only available in py3.5 and 3.4 </p>
<div class="highlight"><pre><span></span><span class="k">[bdist_wheel]</span>
<span class="na">python-tag</span> <span class="o">=</span> <span class="s">py35, py34</span>
</pre></div>


<h2 id="upload"><a name="user-content-upload" href="#upload" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>Upload</h2>
<p>look at <a href="http://python-packaging-user-guide.readthedocs.io/en/latest/distributing/#uploading-your-project-to-pypi">http://python-packaging-user-guide.readthedocs.io/en/latest/distributing/#uploading-your-project-to-pypi</a>  </p>
<p>Create a account on pypi, register your package,  write a <code>~/.pypirc</code> </p>
<div class="highlight"><pre><span></span><span class="k">[distutils]</span>
<span class="na">index-servers</span><span class="o">=</span><span class="s">pypi</span>

<span class="k">[pypi]</span>
<span class="na">repository</span> <span class="o">=</span> <span class="s">https://pypi.python.org/pypi</span>
<span class="na">username</span> <span class="o">=</span> <span class="s">&lt;username&gt;</span>
<span class="na">password</span> <span class="o">=</span> <span class="s">&lt;password&gt;</span>
</pre></div>


<p>left the password empty, you can use twine with <code>-p PASSWORD</code>.  </p>
<p>upload your dist folder  </p>
<p><code>twine upload dist/*</code>  </p>
<h2 id="reference"><a name="user-content-reference" href="#reference" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>Reference</h2>
<ul>
<li><a href="http://python-packaging-user-guide.readthedocs.io/en/latest/distributing/">http://python-packaging-user-guide.readthedocs.io/en/latest/distributing/</a>  </li>
<li><a href="http://peterdowns.com/posts/first-time-with-pypi.html">http://peterdowns.com/posts/first-time-with-pypi.html</a>  </li>
</ul>
<p>2016-05-15 11:43:33</p>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://littlezz.github.io/ri-ben-dong-hua-ren-zhan-lan-hui-zong-jie-yu-tui-jian.html#ri-ben-dong-hua-ren-zhan-lan-hui-zong-jie-yu-tui-jian">日本动画人展览会总结与推荐</a></h2>
    <p>
      Posted on Thu 21 April 2016 in <a href="http://littlezz.github.io/category/acg.html">ACG</a>
      &#8226; Tagged with
      <a href="http://littlezz.github.io/tag/ri-ji.html">日记</a>,      <a href="http://littlezz.github.io/tag/xia-che.html">瞎扯</a>    </p>
  </header>
  <div>
      <p>首先， 不得不提关于这个展览会的纪录片 《庵野先生与我们的莽撞挑战 日本动画人展览会》  </p>
<p>5分钟的动画， 制作时间往往是好几个月， 途中经历的种种困难， 特别是对于新人监督， 经验不足，在现场时的时候很难控制场面。比如第32话的监督， 在配音时说希望林原惠用更成熟一点的语气， 结果林原惠反问『请问监督眼中的成熟是什么呢？ 我没有从人物的脸上看到成熟的气质。』。 然后监督直接吓懵逼，一个工作人员默默递给监督一个红绿按钮的选择键盘，全场没有人敢讲话， 只有监督不断翻着台本的声音。   最后还是林原惠救场， 说在刚才的基础上用更低沉的语气。 监督说很好， 这样就好。 </p>
<p>旁白一针见血的说『现在监督一点很后悔吧』。<br />
但是很多问题最后可能只能妥协。<br />
毕竟学会妥协也是成为优秀监督的必要能力。。。。  </p>
<p>好了， 开始记录那些我喜欢的作品吧。<br />
基于看过纪录片的原因， 我先说32话， 之后的按顺序。  </p>
<h3 id="32"><a name="user-content-32" href="#32" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>32 新世紀いんぱくつ。</h3>
<p>和eva是同一个时间观的， 我特别去看了之前监督和林原惠意见冲突的地方， 讲道理， 其实还是林原惠说得对。。。<del>那张脸上面看不出所谓的成熟</del><br />
然后歌很好听， 非常好听， 背景也非常美，再配上百合， 百合！百合！林原精分现场！自己和自己百合！！  我吼兴奋， 我吼兴奋啊啊啊啊啊啊啊啊啊啊wwww， 可以循环看好多遍。 <br />
<del>我的偶像不可能变成橙汁</del>  </p>
<h3 id="1"><a name="user-content-1" href="#1" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>1 龍の歯医者</h3>
<p>恢弘大作的感觉， 嗯， BGM也很恢弘， 作画也很酷炫。  </p>
<h3 id="2-hill-climb-girl"><a name="user-content-2-hill-climb-girl" href="#2-hill-climb-girl" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>2 HILL CLIMB GIRL</h3>
<p>感觉上是秀3D技术的， 然而我觉得里面的歌曲很好听。  </p>
<h3 id="3-mememe"><a name="user-content-3-mememe" href="#3-mememe" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>3 ME!ME!ME!</h3>
<p>这个不用说了， 很多人说神作啦， 和EVA说的是一个事情啦， 更加容易懂啦， 实用啦。 各种各样。<br />
想要补充的就是其实庵野是没有参与进来的。。。<br />
蛮好看的， 值得一看。 卖肉新高度。而且很带感。有很多符号元素。 总之看得开心就是好的。 </p>
<h3 id="4-carnage"><a name="user-content-4-carnage" href="#4-carnage" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>4 Carnage</h3>
<p>和上一个作品形成鲜明的对比。 <br />
这部作品非常有表现力。<br />
《ME!ME!ME!》 的主题是美少女， 而这部作品的主题是表现故事， 人物和剧情， 都只是表现的手段而已。 当然很多人可能会说『这画风我不喜欢』。 然后结束观看， 然后接着对mememe撸。  </p>
<p>可是我tm真的好喜欢！<br />
那帅到炸裂的分镜， 没有矫揉造作的卖萌，一股浓浓的黑暗风格。 干净利落， 没有多余的台词， 关键的剧情全部用镜头来表达。  </p>
<p>这他妈就是艺术品啊。  </p>
<p>《ME!ME!ME!》确实取得了很高的人气， 如果是真的变成作品放送的话， 多半情况下也是ME!ME!ME!》热卖， 而本作暴死。  </p>
<p>但是总得有人做像《Carnage》这样的动画， 这种东西才称得上是所谓的『动画未来』。 其他的像《mememe》这种模式，商业运作成功， 无可厚非， 毕竟卖bd卖人设，赚了钱活下去才是王道。 但是如果一辈子都干这种事情，而且还时不时披上一个『内涵作』这样的外衣的话，我觉得真的是有点的恶心。  </p>
<h3 id="6-202ldk2"><a name="user-content-6-202ldk2" href="#6-202ldk2" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>6 西荻窪駅徒歩20分2LDK敷礼2ヶ月ペット不可</h3>
<p>和第四话一样， 剧情非常有趣， 动作非常非常的流畅， 非常推荐。  这部作品在纪录片里面有提到。  </p>
<h3 id="10"><a name="user-content-10" href="#10" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>10 ヤマデロイド</h3>
<p>这个也很好看， 配合一首歌曲讲了一个故事， 节奏非常带感， 而且没有对白， 全部用镜头语言来讲故事， 比现在的一些动画恨不得配角24小时全程解说不知道要高到哪里去。  </p>
<p>但是有一点， 这个人脸的画风， 23333 不行， 我一开始以为是要全程颜艺， 但是看旧了好像还是蛮带感的。  </p>
<p>总之很推荐， 剧情也很有爱。  </p>
<h3 id="11-power-plant-no33"><a name="user-content-11-power-plant-no33" href="#11-power-plant-no33" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>11 POWER PLANT No.33</h3>
<p>Trigger， 今石洋之办的那家工作室。<br />
科幻类的，没什么要说的， 值得一看。 ed很好听。  </p>
<h3 id="12-evangelion-another-impactconfidential"><a name="user-content-12-evangelion-another-impactconfidential" href="#12-evangelion-another-impactconfidential" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>12 [evangelion： Another Impact（Confidential）</h3>
<p>卧槽， 说老实话， 我光看画面我真的分不清到底是3D的还是特摄片。  </p>
<p>怕了。  </p>
<h3 id="13-kanon"><a name="user-content-13-kanon" href="#13-kanon" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>13 Kanón</h3>
<p>和其他的不同， 这部全程在说话， 应该是讨论一些东西， 可能是讨论作品和观众的问题吧。<br />
看得下去的话可以一看。  </p>
<h3 id="14-sexviolence-with-machspeed"><a name="user-content-14-sexviolence-with-machspeed" href="#14-sexviolence-with-machspeed" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>14 Sex&amp;VIOLENCE with MACHSPEED</h3>
<p>我是看完这部才想着搞一个总结的。<br />
我最近遇上一些讨厌的事情， 没有什么道理可以讲， 对面只会不断的追问『你为什么』 和『你凭什么』。 就像这部作品所表达的东西一样： 没有为什么， 我tm就是要为之一战。</p>
<p>这可能是现在无可奈何的我内心深处非常羡慕敢想而不敢讲的东西吧。  </p>
<p>2016年04月21日21:41:15   </p>
<h3 id="15"><a name="user-content-15" href="#15" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>15 おばけちゃん</h3>
<p>2333<br />
好有趣， 前面都是一点蠢萌蠢萌的片段，全都是neta， 但是如果坚持到最后， 会有好的收获的。  </p>
<p>而且， ed是重点， 最后出现了鹤卷和哉！</p>
<h3 id="16"><a name="user-content-16" href="#16" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>16</h3>
<p>这什么鬼。。。<br />
剧情一头雾水， 然后各种风格的混搭， 设定的不明。<br />
总之我觉得不好看。</p>
<h3 id="17"><a name="user-content-17" href="#17" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>17 三本の証言者</h3>
<p>卧槽， 居然是剧情片， 短篇+剧情=很难看懂。<br />
不过还是值得一看的。  </p>
<h3 id="19-i-can-friday-by-day"><a name="user-content-19-i-can-friday-by-day" href="#19-i-can-friday-by-day" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>19 I can Friday by day!</h3>
<p>卧槽！！！<br />
我就是在找这个啊，  监督是 <strong>鹤卷和哉</strong> !重复一遍， 监督是鹤卷和哉！ </p>
<p>别废话了， 抓紧看吧， 和flcl一样的感觉， 猜不到开头， 更加猜不到结尾。</p>
<p>2016年04月22日03:20:30</p>
<h3 id="22"><a name="user-content-22" href="#22" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>22 イブセキヨルニ</h3>
<p>这个东西讨论到政治了。<br />
和我当初看这个博览会的注重点不同， 不过老实话， 监督脑洞真是大， 真敢拍啊。  </p>
<p>没看的话可以看一下。  </p>
<h3 id="25"><a name="user-content-25" href="#25" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>25 ハンマーヘッド</h3>
<p>妈的， 一股沙耶之歌的感觉。<br />
卧槽， 还是给我看一集萌妹中和一下吧我的天， 这从20 开始的一系列都是药吃多了么。  </p>
<p>和前面一样， 没看的话可以看一下。  </p>
<h3 id="26-1989"><a name="user-content-26-1989" href="#26-1989" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>26 コント  ころしや　1989</h3>
<p>这个很有趣。 简直是超展开。  </p>
<h3 id="29"><a name="user-content-29" href="#29" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>29 ヒストリー機関</h3>
<p>可以一看。<br />
一开始看我以为又是政治片， 结果看到后面发现是脑洞片。<br />
说老实话， 我比较想看的是表现手法， 即， 我认为， 举办这个活动的目的是抛开商业， 抛开蓝光销量， 抛开各种制约，你会怎么做动画片，你会用什么样的形式你有什么样没有敢实践的创意。 而不是一说到自由创作， 就想方设法展现自己对政治对人类历史的洞见，找一些看似高深的角度， 然后做一下浅薄幼稚的讨论。<br />
有些东西， 需要去看书去明白， 而不是看几集动画片就能说清楚的， 拼命的传达自己的见解， 丧失了最基础的娱乐性， 只剩说教， 那观众为何不去看公开课？<br />
（<del>没错， 我说的就是那种整天一副讨论正义是什么的动画</del>） </p>
<h3 id="31-girl"><a name="user-content-31-girl" href="#31-girl" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>31 GIRL</h3>
<p>和mememe一样的团队做的（没错， 就是那两个人）.<br />
本来没什么好说的， 但是想了一下， 那个眼睛的画法真的很好的表达了人物一副不知道在想什么而且还很容易冷场的形象。<br />
而且我感觉这个画面实在是太华丽了吧。 我的天。  </p>
<h3 id="34"><a name="user-content-34" href="#34" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>34 旅のロボから</h3>
<p>卧槽， 监督在业界是被称为师匠的男人。<br />
真的是不一样啊。mememe的作画监督说自己非常崇拜他， 说他有某种特别的特质， 才能画出这样工口感这么强的画。<br />
我感觉这个人对生活的观察非常的细腻。 如果说mememe的作者在发掘美少女设计上面独树一帜的话， 那么本作的监督则是在美少女的动作方面达到了超一流。  </p>
<p>里面美少女的动作， 非常的流畅， 非常的写实，所以能够让人感觉『生动』。<br />
之前有个笑话是嘲笑部分画师画妹子泡温泉的时候头发是披下来的， 说可怜的死宅， 连妹子的手都没有摸过2333.<br />
那么本作的监督绝对是那种知道要让妹子把头发盘起来， 同时还能把怎么盘的具体动作画出来，而且还画得超乎想象的优雅的那种。  </p>
<p>不愧是『师匠』  </p>
<p>这种感觉， 就想白箱里面的那个老一代的画师， 基础功扎实到可怕， 不是现在的画师能够随便超越的那种存在。  </p>
<p><del>我觉得特别的特质之一是人家有女朋友吧喂！</del></p>
<h3 id="35"><a name="user-content-35" href="#35" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>35 カセットガール</h3>
<p>这个。。。这个。。 这个是向庵野秀明毕业作品致敬么？  </p>
<p>2016年04月25日00:02:40</p>
<h3 id="_1"><a name="user-content-_1" href="#_1" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>最后</h3>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://littlezz.github.io/guan-yu-wo-bu-zai-de-jie-dao-ping-fen-de-yi-dian-si-kao.html#guan-yu-wo-bu-zai-de-jie-dao-ping-fen-de-yi-dian-si-kao">关于《我不在的街道》评分的一点思考</a></h2>
    <p>
      Posted on Mon 04 April 2016 in <a href="http://littlezz.github.io/category/acg.html">ACG</a>
      &#8226; Tagged with
      <a href="http://littlezz.github.io/tag/ri-ji.html">日记</a>,      <a href="http://littlezz.github.io/tag/xia-che.html">瞎扯</a>,      <a href="http://littlezz.github.io/tag/xiao-jie.html">小结</a>    </p>
  </header>
  <div>
      <p>我给了9分（神作）  </p>
<p>刚看完的时候， 对于那个操蛋的结尾， 我也是想打七分的， 但是觉得实在太低， 对不起那个惊艳的开头， 于是给八分。  </p>
<p>过了1天， 我连续半话弃掉了3部番， 其中包括《fate stay night UBW》， 我在群里面说， 『不行， 刚看完扑街， 其他番根本没有办法看， 全部半话弃』<br />
直到此刻， 我才明白， 有多少番， 我甚至没有办法看完第一话， 更不用说考虑什么剧情了。  </p>
<p>我开始察觉到自己， 以及大部分人的可笑。<br />
一副严肃认真， 公平正义的态度， 打上一个完全主观的分数， 留下一句似是而非的自己评分准则。<br />
俨然一副资深人士的样子。  </p>
<p>然而来来回回， 不还是局限在剧情方面？<br />
一部动画， 构图， 分镜， 配音， 上色， 配乐等等， 这么多元素在里面， 最后大家却振振有词的依据剧情来打分， 还能说得头头是道。  </p>
<p>我才明白当时的我也是如此， 也就是在那时， 我才会想起我起初看这个动画的时候的兴奋之情， 我大呼卧槽， 我呼啦一下打开房间的门， 我走到从来不看番的室友的房间， 我说， 卧槽， 我要通宵看完这部番了， 我已经有几年没有这种想要通宵看番的冲动了， 上一次这样还是高中， 看得是石头门。<br />
我在一集结束的时候， 高呼悠木碧， 棒啊啊啊啊。 我说， fuck them all！ 到后面， 我室友都跑过来我们两个熬夜看番了。  </p>
<p>也就是那时， 我才会想起， 有多少回， 我被里面的一幕触动到， 我说， 就凭此刻， 足以封神。   </p>
<p>所以我改成了9分， 为了我当初的承诺， 为了第二话那句『原来我也有过这样的时间啊』， 为了在记录那时感想时触动的回忆让我流着泪写完观后感。  </p>
<p>如果此刻我还保持着一副正人君子， 道貌岸然， 满口胡言的扯着剧情的『公平之人』， 那我就是一个双料的傻瓜。  </p>
<p>干他娘的， 我就是要给9分， 有傻逼打低分， 为什么我就不能打高分？  </p>
<p>说到底， 为什么作品的排名会被高低分这种东西牵制。 或者说如何排除傻逼对一个作品的影响。  </p>
<p>投票者投票表决天才， 但是有一个前提是， 如何保证投票者本身不是平庸之流。  </p>
<p>抛开知乎这种社交性质的网站不谈， 如果是这种个人评分性质，带有很重的个人主观口味性质的，但是最后却是统计平均数的网站来看。 应该首先匹配评分者中和当前用户匹配率高的用户， 重新分配权重。  </p>
<p>咦， 这不就是协同过滤么。。。  </p>
<p>说来， 要先解决计算用户之间的距离的问题， 然后重新分配权重， 然后重新得到分数， 卧槽， 简单啊。  </p>
<p>我是不是可以去写一个啊。。。？  </p>
<p>看情况， 先把之前的坑给填了先。  </p>
<p>2016年04月04日19:37:51</p>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://littlezz.github.io/travis-ci-with-numpy-and-pytest.html#travis-ci-with-numpy-and-pytest">Travis CI with Numpy and Pytest</a></h2>
    <p>
      Posted on Thu 31 March 2016 in <a href="http://littlezz.github.io/category/python.html">Python</a>
      &#8226; Tagged with
      <a href="http://littlezz.github.io/tag/python.html">python</a>,      <a href="http://littlezz.github.io/tag/numpy.html">numpy</a>,      <a href="http://littlezz.github.io/tag/xiao-jie.html">小结</a>    </p>
  </header>
  <div>
      <p>It takes long time to install scientific python package by <code>pip</code> in travis and sometime fail.  </p>
<p>The solve is to use conda to install binary package. <br />
<a href="http://conda.pydata.org/docs/travis.html">http://conda.pydata.org/docs/travis.html</a>  </p>
<p>Note that some package not in conda, you can use <code>pip</code> install it, for example, <code>py.test</code>  </p>
<p>Here is my <a href="https://github.com/littlezz/ESL-Model">ESL-Model</a> .trais.yml, you can view on github <a href="https://github.com/littlezz/ESL-Model/blob/master/.travis.yml">https://github.com/littlezz/ESL-Model/blob/master/.travis.yml</a>  </p>
<p><div class="highlight"><pre><span></span>language: python
python:
  <span class="c1"># We don&#39;t actually use the Travis Python, but this keeps it organized.</span>
  - <span class="s2">&quot;3.5&quot;</span>

install:
  - sudo apt-get update
  <span class="c1"># We do this conditionally because it saves us some downloading if the</span>
  <span class="c1"># version is the same.</span>
  - <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;</span><span class="nv">$TRAVIS_PYTHON_VERSION</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;2.7&quot;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
      wget https://repo.continuum.io/miniconda/Miniconda-latest-Linux-x86_64.sh -O miniconda.sh<span class="p">;</span>
    <span class="k">else</span>
      wget https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh<span class="p">;</span>
    <span class="k">fi</span>
  - bash miniconda.sh -b -p <span class="nv">$HOME</span>/miniconda
  - <span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$HOME</span><span class="s2">/miniconda/bin:</span><span class="nv">$PATH</span><span class="s2">&quot;</span>
  - <span class="nb">hash</span> -r
  - conda config --set always_yes yes --set changeps1 no
  - conda update -q conda
  <span class="c1"># Useful for debugging any issues with conda</span>
  - conda info -a

  - conda create -q -n test-environment <span class="nv">python</span><span class="o">=</span><span class="nv">$TRAVIS_PYTHON_VERSION</span> pandas numpy scipy scikit-learn
  - <span class="nb">source</span> activate test-environment
  - python setup.py install
  - pip install pytest

script:
  - py.test


notifications:
  email:
    on_success: never
    on_failure: always
</pre></div>
<br />
Note that you should install pytest manually instead use pre-install one.</p>
<p>However, you can not use tox with conda direct, try ctox <a href="https://github.com/hayd/ctox">https://github.com/hayd/ctox</a>  </p>
<p>2016-03-31 16:19:38</p>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://littlezz.github.io/how-to-write-reduced-rank-linear-discriminant-analysis-with-python.html#how-to-write-reduced-rank-linear-discriminant-analysis-with-python">How to Write Reduced Rank Linear Discriminant Analysis with Python</a></h2>
    <p>
      Posted on Sat 26 March 2016 in <a href="http://littlezz.github.io/category/machine-learning.html">Machine-Learning</a>
      &#8226; Tagged with
      <a href="http://littlezz.github.io/tag/machine-learning.html">machine learning</a>,      <a href="http://littlezz.github.io/tag/ji-qi-xue-xi.html">机器学习</a>,      <a href="http://littlezz.github.io/tag/python.html">python</a>,      <a href="http://littlezz.github.io/tag/xiao-jie.html">小结</a>,      <a href="http://littlezz.github.io/tag/numpy.html">numpy</a>    </p>
  </header>
  <div>
      <h2 id="intro"><a name="user-content-intro" href="#intro" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>Intro</h2>
<p>I'm working on a project named <a href="https://github.com/littlezz/ESL-Model">ESL-Model</a> which I want to use python to implent algorithm from The Elements of Statistical Learning. I start writing RRLDA the day before yesterday,  and I sccuessfully finish until today.  </p>
<p>Notice that I am using Python3.5, which allow me use <code>@</code> instead of <code>np.dot</code>  </p>
<h2 id="the-difference-between-numpy-and-r"><a name="user-content-the-difference-between-numpy-and-r" href="#the-difference-between-numpy-and-r" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>The difference between Numpy and R</h2>
<p>Firstly, Numpy is slight different with R in eigen decomposition(I spent lots of time to find out T_T).  </p>
<p>In R, the eigenvalues return from <code>eigen</code> is descending, which is all notes assume.<br />
But Numpy <code>np.linalg.eigh</code> return eigenvalues in ascending order.  </p>
<p>It is doesn't matter when you work on LDA, because it use both <span class="math">\(V\)</span> and <span class="math">\(D\)</span>, but it influence the result in Reduced rank LDA which you use column of <span class="math">\(V\)</span> alone.  </p>
<p>To slove this problem, you may use <code>np.fliplr</code>.  </p>
<div class="highlight"><pre><span></span><span class="n">W</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span> <span class="mf">0.9967</span><span class="p">,</span>  <span class="mf">0.002</span> <span class="p">],</span>
       <span class="p">[</span> <span class="mf">0.002</span> <span class="p">,</span>  <span class="mf">1.0263</span><span class="p">]])</span>

<span class="n">Dw</span><span class="p">,</span> <span class="n">Uw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">W</span><span class="p">)</span>
<span class="n">Dw</span> <span class="o">=</span> <span class="n">Dw</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">Uw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fliplr</span><span class="p">(</span><span class="n">Uw</span><span class="p">)</span>
</pre></div>


<p>You can get </p>
<div class="highlight"><pre><span></span>print(Dw)
[ 1.02643452  0.99656548]


print(Dw)
[[ 0.06711024 -0.99774557]
 [ 0.99774557  0.06711024]]
</pre></div>


<h2 id="how-to-write-reduced-rank-lda"><a name="user-content-how-to-write-reduced-rank-lda" href="#how-to-write-reduced-rank-lda" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>How to Write Reduced Rank LDA</h2>
<p>Finally, we arrive at the algorithm.<br />
I mainly reference <a href="http://sites.stat.psu.edu/~jiali/course/stat597e/notes2/lda2.pdf">http://sites.stat.psu.edu/~jiali/course/stat597e/notes2/lda2.pdf</a>. <br />
Which is a very very nice ppt, thanks it very much!  </p>
<ul>
<li>
<p>Find the centroids for all the classes and class prior probabilities, which is the same in LDA (<span class="math">\(\mu_k\)</span> and <span class="math">\(\pi_k\)</span>).  </p>
</li>
<li>
<p>Find between-class covariance matrix B using the centroid vectors and class prior probabilities<br />
    suppose <span class="math">\(\mu_k\)</span> is column vector</p>
<p><span class="math">\(\mu = \Sigma_1^K \mu_k\)</span><br />
<span class="math">\(B =  \Sigma_1^K \pi_k(\mu - \mu_k)(\mu - \mu_k)^T\)</span></p>
<p><strong>Notice that the code dosen't take same shape with formula</strong>  </p>
<div class="highlight"><pre><span></span><span class="n">W</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Sigma_hat</span>
<span class="c1"># prior probabilities (K,1)</span>
<span class="n">Pi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Pi</span>
<span class="c1"># class centroids (K, p)</span>
<span class="n">Mu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Mu</span>
<span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span>
<span class="c1"># the number of class</span>
<span class="n">K</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span>
<span class="c1"># the dimension you want</span>
<span class="n">L</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span>

<span class="c1"># Mu is (K,p) matrix, Pi is (K,1)</span>
<span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Pi</span> <span class="o">*</span> <span class="n">Mu</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">p</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>

<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K</span><span class="p">):</span>
    <span class="c1"># vector @ vector equal scalar, use vector[:, None] to transform to matrix</span>
    <span class="c1"># vec[:, None] equal to vec.reshape((1, vec.shape[0]))</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">B</span> <span class="o">+</span> <span class="n">Pi</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="p">((</span><span class="n">Mu</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">mu</span><span class="p">)[:,</span> <span class="bp">None</span><span class="p">]</span> <span class="err">@</span> <span class="p">((</span><span class="n">Mu</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">mu</span><span class="p">)[</span><span class="bp">None</span><span class="p">,</span> <span class="p">:]))</span>
</pre></div>


</li>
<li>
<p>Find within-class covariance matrix W, the same with <span class="math">\(\hat \Sigma\)</span> in LDA.  </p>
</li>
<li>
<p>eigen decomposition W</p>
<p><span class="math">\(W = V_WD_WV_W^T\)</span><br />
Define <span class="math">\(W^{1/2} = D_W^{1/2}V_W^T\)</span></p>
<p>So <span class="math">\(W^{-\frac{1}{2}} = (W^{1/2})^{-1}\)</span>  </p>
<div class="highlight"><pre><span></span><span class="c1"># Be careful, the `eigh` method get the eigenvalues in ascending , which is opposite to R.</span>
<span class="n">Dw</span><span class="p">,</span> <span class="n">Uw</span> <span class="o">=</span> <span class="n">LA</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">W</span><span class="p">)</span>
<span class="c1"># reverse the Dw_ and Uw</span>
<span class="n">Dw</span> <span class="o">=</span> <span class="n">Dw</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">Uw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fliplr</span><span class="p">(</span><span class="n">Uw</span><span class="p">)</span>

<span class="n">W_half</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diagflat</span><span class="p">(</span><span class="n">Dw</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span> <span class="err">@</span> <span class="n">Uw</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</pre></div>


</li>
<li>
<p>compute <span class="math">\(B^*\)</span><br />
<span class="math">\(B^* = (W^{-\frac{1}{2}})^TBW^{-\frac{1}{2}}\)</span>  </p>
<div class="highlight"><pre><span></span><span class="n">B_star</span> <span class="o">=</span> <span class="n">W_half</span><span class="o">.</span><span class="n">T</span> <span class="err">@</span> <span class="n">B</span> <span class="err">@</span> <span class="n">W_half</span>
</pre></div>


</li>
<li>
<p>eigen decompostion <span class="math">\(B^*\)</span>, get <span class="math">\(a_l\)</span><br />
<span class="math">\(B^* = VDV^T\)</span><br />
<span class="math">\(a_l = W^{-\frac{1}{2}}V_l\)</span></p>
<div class="highlight"><pre><span></span><span class="n">D_</span><span class="p">,</span> <span class="n">V</span> <span class="o">=</span> <span class="n">LA</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">B_star</span><span class="p">)</span>

<span class="c1"># reverse V</span>
<span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fliplr</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>

<span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">L</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>
<span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">L</span><span class="p">):</span>
    <span class="n">A</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">W_half</span><span class="p">)</span> <span class="err">@</span> <span class="n">V</span><span class="p">[:,</span> <span class="n">l</span><span class="p">]</span>
</pre></div>


</li>
<li>
<p>transform X and <span class="math">\(\mu_k\)</span> and get predict value<br />
<span class="math">\(\hat x = Ax\)</span><br />
<span class="math">\(\hat \mu_k = A\mu_k\)</span></p>
<p>find <span class="math">\(argmin_k {|\hat x- \hat\mu|_2^2 - log(\pi_k)}\)</span></p>
<div class="highlight"><pre><span></span><span class="n">X_star</span> <span class="o">=</span> <span class="n">X</span> <span class="err">@</span> <span class="n">A</span><span class="o">.</span><span class="n">T</span>

<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">):</span>
    <span class="c1"># mu_s_star shape is (p,)</span>
    <span class="n">mu_k_star</span> <span class="o">=</span> <span class="n">A</span> <span class="err">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">Mu</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

    <span class="c1"># Ref: http://docs.scipy.org/doc/numpy/reference/generated/numpy.linalg.norm.html</span>
    <span class="c1"># Ref: http://stackoverflow.com/questions/1401712/how-can-the-euclidean-distance-be-calculated-with-numpy</span>
    <span class="n">Y</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">LA</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">X_star</span> <span class="o">-</span> <span class="n">mu_k_star</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">-</span> <span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Pi</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

<span class="c1"># Python index start from 0, transform to start with 1</span>
<span class="n">y_hat</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
</pre></div>


</li>
</ul>
<h2 id="put-it-together"><a name="user-content-put-it-together" href="#put-it-together" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>Put it Together</h2>
<p>You can find complete code in here<br />
<a href="https://github.com/littlezz/ESL-Model/blob/master/esl_model/ch4/model.py">https://github.com/littlezz/ESL-Model/blob/master/esl_model/ch4/model.py</a></p>
<h2 id="reference"><a name="user-content-reference" href="#reference" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>Reference</h2>
<ul>
<li>The Elements of Statistical Learning 2nd Edition section 4.3.2 - 4.3.3  </li>
<li><a href="http://sites.stat.psu.edu/~jiali/course/stat597e/notes2/lda2.pdf">http://sites.stat.psu.edu/~jiali/course/stat597e/notes2/lda2.pdf</a>  </li>
<li><a href="https://onlinecourses.science.psu.edu/stat857/node/83">https://onlinecourses.science.psu.edu/stat857/node/83</a></li>
<li><a href="http://www.stat.cmu.edu/~ryantibs/datamining/lectures/21-clas2-marked.pdf">http://www.stat.cmu.edu/~ryantibs/datamining/lectures/21-clas2-marked.pdf</a></li>
</ul>
<p>2016-03-26 15:43:45</p>
<script type="text/javascript">if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) {
    var align = "left",
        indent = "0em",
        linebreak = "false";

    if (true) {
        align = (screen.width < 768) ? "left" : align;
        indent = (screen.width < 768) ? "0em" : indent;
        linebreak = (screen.width < 768) ? 'true' : linebreak;
    }

    var mathjaxscript = document.createElement('script');
    var location_protocol = (false) ? 'https' : document.location.protocol;
    if (location_protocol !== 'http' && location_protocol !== 'https') location_protocol = 'https:';
    mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#';
    mathjaxscript.type = 'text/javascript';
    mathjaxscript.src = location_protocol + '//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML';
    mathjaxscript[(window.opera ? "innerHTML" : "text")] =
        "MathJax.Hub.Config({" +
        "    config: ['MMLorHTML.js']," +
        "    TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } }," +
        "    jax: ['input/TeX','input/MathML','output/HTML-CSS']," +
        "    extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']," +
        "    displayAlign: '"+ align +"'," +
        "    displayIndent: '"+ indent +"'," +
        "    showMathMenu: true," +
        "    messageStyle: 'normal'," +
        "    tex2jax: { " +
        "        inlineMath: [ ['\\\\(','\\\\)'] ], " +
        "        displayMath: [ ['$$','$$'] ]," +
        "        processEscapes: true," +
        "        preview: 'TeX'," +
        "    }, " +
        "    'HTML-CSS': { " +
        "        styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'inherit ! important'} }," +
        "        linebreaks: { automatic: "+ linebreak +", width: '90% container' }," +
        "    }, " +
        "}); " +
        "if ('default' !== 'default') {" +
            "MathJax.Hub.Register.StartupHook('HTML-CSS Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax['HTML-CSS'].FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
            "MathJax.Hub.Register.StartupHook('SVG Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax.SVG.FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
        "}";
    (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript);
}
</script>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://littlezz.github.io/fuck-the-reduced-rank-lda.html#fuck-the-reduced-rank-lda">Fuck the Reduced-rank LDA</a></h2>
    <p>
      Posted on Fri 25 March 2016 in <a href="http://littlezz.github.io/category/machine-learning.html">Machine-Learning</a>
      &#8226; Tagged with
      <a href="http://littlezz.github.io/tag/machine-learning.html">machine learning</a>,      <a href="http://littlezz.github.io/tag/ji-qi-xue-xi.html">机器学习</a>,      <a href="http://littlezz.github.io/tag/ta-ma-de.html">他妈的</a>,      <a href="http://littlezz.github.io/tag/xue-xue-xue-xue-ge-pi.html">学学学，学个屁</a>    </p>
  </header>
  <div>
      <p>从昨天开始一直在弄RRLDA， 直到今天晚上， 无果。<br />
搜索各种资料， 各自有理， 到最后连计算 <span class="math">\(W^{-\frac{1}{2}}\)</span> 都能有不同的版本。  </p>
<p>权当整理思路吧， 整理一下各种版本（可能我编程有问题， 反正所有版本我都没能算对：）  </p>
<h2 id="esl"><a name="user-content-esl" href="#esl" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>版本一： ESL</h2>
<p>page 114 页的算法。<br />
我翻译一下：  </p>
<ul>
<li>计算 类的重心 K x P 的矩阵M， 还有公共协方差矩阵W；</li>
<li>计算 <span class="math">\(M^* = MW^{-\frac{1}{2}}\)</span>, 使用W的特征分解；</li>
<li>计算<span class="math">\(B^*\)</span>, <span class="math">\(M^*\)</span>的协方差矩阵（B是为了between-class）, 还有他的特征分解 <span class="math">\(B^* = V^*D_BV^{*T}\)</span>. <span class="math">\(V^*\)</span>的按顺序的列<span class="math">\(v_l^*\)</span>定义了最佳子空间的坐标。  </li>
</ul>
<p>卧槽， 我他妈看懂了。<br />
我往下看了一行。 <br />
书上的意思是说， 你本来要算这些jb玩意的， 但是后来有一个叫做『捕鱼者（fisher）』的捕鱼达人， 给出了更吊的东西， 卧槽， 我他妈真的咸鱼啊， 这个人一波收割啊卧槽。  </p>
<p>那我懂了， 我接着看书了。  </p>
<p>FUCK！<br />
FUCK ME！</p>
<p>2016年03月25日00:46:12</p>
<script type="text/javascript">if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) {
    var align = "left",
        indent = "0em",
        linebreak = "false";

    if (true) {
        align = (screen.width < 768) ? "left" : align;
        indent = (screen.width < 768) ? "0em" : indent;
        linebreak = (screen.width < 768) ? 'true' : linebreak;
    }

    var mathjaxscript = document.createElement('script');
    var location_protocol = (false) ? 'https' : document.location.protocol;
    if (location_protocol !== 'http' && location_protocol !== 'https') location_protocol = 'https:';
    mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#';
    mathjaxscript.type = 'text/javascript';
    mathjaxscript.src = location_protocol + '//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML';
    mathjaxscript[(window.opera ? "innerHTML" : "text")] =
        "MathJax.Hub.Config({" +
        "    config: ['MMLorHTML.js']," +
        "    TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } }," +
        "    jax: ['input/TeX','input/MathML','output/HTML-CSS']," +
        "    extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']," +
        "    displayAlign: '"+ align +"'," +
        "    displayIndent: '"+ indent +"'," +
        "    showMathMenu: true," +
        "    messageStyle: 'normal'," +
        "    tex2jax: { " +
        "        inlineMath: [ ['\\\\(','\\\\)'] ], " +
        "        displayMath: [ ['$$','$$'] ]," +
        "        processEscapes: true," +
        "        preview: 'TeX'," +
        "    }, " +
        "    'HTML-CSS': { " +
        "        styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'inherit ! important'} }," +
        "        linebreaks: { automatic: "+ linebreak +", width: '90% container' }," +
        "    }, " +
        "}); " +
        "if ('default' !== 'default') {" +
            "MathJax.Hub.Register.StartupHook('HTML-CSS Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax['HTML-CSS'].FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
            "MathJax.Hub.Register.StartupHook('SVG Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax.SVG.FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
        "}";
    (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript);
}
</script>
  </div>
</article>

  <div class="pagination">
    <a class="btn" href="http://littlezz.github.io/index2.html">
      <i class="fa fa-angle-left"></i> Older Posts
    </a>
  </div>

    <footer>
        <p>&copy; littlezz 2015</p>
<p>Built using <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a></p>    </footer>
  </main>





<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " littlezz's Blog ",
  "url" : "http://littlezz.github.io",
  "image": "/images/logo.jpg",
  "description": "littlezz's Thoughts and Writings About Python And Machine Learning and diary"
}
</script></body>
</html>