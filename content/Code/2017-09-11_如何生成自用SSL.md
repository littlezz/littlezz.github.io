Title: 如何生成自用的 SSL 认证证书  
Tags: 小结, 计算机网络

本文结合 [creating-your-own-ssl-certificate-authority][1] 这篇文章，描述如何生成一个4096位的私有证书， 同时解决 Chrome 浏览器不识别的问题。 

Let's encrypt 只能对域名签发证书， 如果希望在内网中使用， 或者是对 IP 使用， 需要自己签发证书。  

总览
----
证书是为了在使用 HTTPS 中对对方进行认证， 确认目标。所以证书都是对域名或者 ip 签发的。  
对于自用证书，一般有两种方式，一种是生成一对证书，然后服务器和客户端分别装上。  
另一种方法是生成一个『根认证证书』，再由这个根认证配合秘钥向服务器签发证书，服务器安装根认证，之后可以识别所有这个根认证签发的服务器的证书。  


我们首先将生成证书认证（CA）， 之后用 CA 对服务器签发证书（cert）

生成 CA 的步骤：  

1. 生成秘钥
2. 自签名
3. 在客户端上安装 CA

之后用 CA 对服务器签发证书:

1. 生成CSR
2. 利用 CA 和秘钥对CSR 签名


生成根证书
--------
根证书只用生成一次

###生成秘钥
秘钥需要被**严格保密**。

    openssl genrsa -out rootCA.key 4096
    
这里生成了4096位的秘钥

###自签名
自签名后生成的 pem 文件用于在客户端上面安装。  

    openssl req -x509 -new -nodes -key rootCA.key -sha384 -days 8192 -out rootCA.pem

这里采用了 sha384，以及有效期设置为了8192天  

之后会进入一个交互页面， 按需要填写对应的信息。  

###在客户端上面安装根认证
Chrome 和 Safari 和 IE 都使用系统的证书管理， 把.pem文件安装， 然后设置为任何时间都信任。  
firefox 有自己的证书系统， 需要特别的在浏览器内安装

对服务器签发证书
-------------
每个服务器都单独的签发。

###生成 CSR

1. 先生成一个新的私钥

        openssl genrsa -out test_server.key 2048
    
2. 生成 certificate signing request.

        openssl req -new -key test_server.key -out test_server.csr
    
    和之前一样， 会进入一个交互式的设置， 其中， 需要正确设置`common-name`  
     
        Common Name (eg, YOUR name) []: 192.168.1.112

###签发证书
####v3.ext
为了解决 google 不识别 subjectaltname 从而不识别证书的问题， 需要新建一个 `v3.ext`，写入下面内容

```
authorityKeyIdentifier=keyid,issuer
basicConstraints=CA:FALSE
keyUsage = digitalSignature, nonRepudiation, keyEncipherment, dataEncipherment
subjectAltName = IP:192.168.1.112
```
ip可以替换为自己要签发的 ip

####签发证书
    openssl x509 -req -in test_server.csr -CA rootCA.pem -CAkey rootCA.key -CAcreateserial -out test_server.crt -days 7500 -sha384 -extfile ./v3.ext


总结
----
到此，我们有了

```
rootCA.key      rootCA.srl      test_server.csr
rootCA.pem      test_server.crt test_server.key
```

这些文件， 其中`rootCA.key`需要被妥善保管， 任何拥有`rootCA.key`都可以伪造签发证书。  

`rootCA.pem`公开， 用于客户端安装  

`test_server.key`以及`test_server.crt`保密， 用于在服务器运行时提供给服务器。  


2017年09月11日17:52:15


[1]: https://datacenteroverlords.com/2012/03/01/creating-your-own-ssl-certificate-authority/
