Title: Python打包时添加非代码文件的坑
Tags: python, 小结

对于 Python 的打包， 通常有两种， 一种是对源文件打包， 一种是安装包， 既在上传 pypi 的时候一般会执行

```sh
python3 setup.py sdist bdist_wheel
```

使用pip安装的时候一般是安装bdist打包出来的文件。

关于在打包中加入非程序文件， 有几种方法， 一种是在 MANIFEST.in 中加入， 对于 setup.py 中也提供了`package_data`参数， 另外对于 setuptools 还提供了特别的 `include_package_data`的参数， 接下来介绍这些参数的意义和怎么用。  


MANIFEST.in
-----------
MANIFEST.in文件是针对 源文件打包 的， 当需要把非程序文件， 包括README， css或者test文件等加入时， 在MANIFEST.in中指定， 用于生成MANIFEST

MIANIFEST会暗中自动寻找以下的文件：  

- 所有`py_modules` 和 `packages`中没有明确说明的python文件 
- ext_modules 或 libraries选项中指明的C文件
- `scripts`指明的文件
- 所有看上去像是test文件的， 比如`tests/*.py`
- README.txt 或者 README, setup.py, setup.cfg
- `package_data`中指明的文件
- `data_files`中指明的文件

package_data
------------
`package_data`是在setup.py中的参数， 用于控制安装包里面包含的文件。  
应该这样理解， MANIFEST 控制 sdist 包含的内容， package_data控制bdist包含的内容。  

一般情况是， 对源文件打包里面一般包含README， tests这些， 但是对于安装包这不需要。  所以分开设置。  


include_package_data
--------------------
坑就是指`include_package_data`， 这个参数是setuptools特有的， 但是非常容易让人误解然后勿用。 setuptools的文档中是这样写的

>If set to True, this tells setuptools to automatically include any data files it finds inside your package directories that are specified by your MANIFEST.in file. For more information, see the section below on Including Data Files.

设为 True 时， 打包时setuptools 会自动加入在 MANIFEST.in中指定的文件。

 
原本是 MANIFEST 在 setup.py 中的`package_data`寻找额外的文件的， 现在变成大家以 MANIFEST.in 为准了。

这会发生什么事情呢， 
如果你同时用了`include_package_data`和`package_data`， 那么你的 sdist 就会瞬间爆炸。  
bdist 打包出来的东西会包含`package_data`中的内容， 但是源代码打包的时候就会失去在`package_data`中指明的文件。  




总结
----
**永远也不要用`include_package_data`**  

`MANIFEST.in` 用来给源文件打包， 里面包含许多额外的信息， 比如测试文件之类的。  

`package_data`用于指定安装时加入的额外的文件， 不需要再MANIFEST.in中重复定义， 源文件打包的时候回自动包含这里面的文件。  


参考:

- [specifying-the-files-to-distribute](https://docs.python.org/3.4/distutils/sourcedist.html#specifying-the-files-to-distribute)  
- [setuptools](https://setuptools.readthedocs.io/en/latest/setuptools.html#including-data-files)

2016年12月12日01:04:25

